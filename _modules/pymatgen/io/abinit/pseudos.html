<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.io.abinit.pseudos &mdash; pymatgen 3.6.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3.6.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 3.6.1 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 3.6.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.io.abinit.pseudos</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="c1"># Copyright (c) Pymatgen Development Team.</span>
<span class="c1"># Distributed under the terms of the MIT License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides objects describing the basic parameters of the</span>
<span class="sd">pseudopotentials used in Abinit, and a parser to instantiate pseudopotential objects..</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">monty.collections</span> <span class="kn">import</span> <span class="n">AttrDict</span><span class="p">,</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">monty.dev</span> <span class="kn">import</span> <span class="n">deprecated</span>
<span class="kn">from</span> <span class="nn">monty.functools</span> <span class="kn">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">monty.io</span> <span class="kn">import</span> <span class="n">FileLock</span>
<span class="kn">from</span> <span class="nn">monty.itertools</span> <span class="kn">import</span> <span class="n">iterator_from_slice</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MSONable</span><span class="p">,</span> <span class="n">MontyDecoder</span>
<span class="kn">from</span> <span class="nn">monty.os.path</span> <span class="kn">import</span> <span class="n">find_exts</span>
<span class="kn">from</span> <span class="nn">monty.string</span> <span class="kn">import</span> <span class="n">list_strings</span><span class="p">,</span> <span class="n">is_string</span>

<span class="kn">from</span> <span class="nn">pymatgen.analysis.eos</span> <span class="kn">import</span> <span class="n">EOS</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.periodic_table</span> <span class="kn">import</span> <span class="n">Element</span>
<span class="kn">from</span> <span class="nn">pymatgen.serializers.json_coders</span> <span class="kn">import</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.plotting_utils</span> <span class="kn">import</span> <span class="n">add_fig_kwargs</span><span class="p">,</span> <span class="n">get_ax_fig_plt</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Pseudo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PseudoTable&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Matteo Giantomassi&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Matteo Giantomassi&quot;</span>

<span class="c1"># Tools and helper functions.</span>


<span class="k">def</span> <span class="nf">straceback</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns a string with the traceback.&quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">nlines</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read at most nlines lines from file filename.</span>
<span class="sd">    If nlines is &lt; 0, the entire file is read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">nlines</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fh</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lineno</span> <span class="o">==</span> <span class="n">nlines</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>

<span class="n">_l2str</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">_str2l</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_l2str</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">l2str</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the angular momentum l (int) to string.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_l2str</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Unknown angular momentum, received l = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l</span>


<span class="k">def</span> <span class="nf">str2l</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a string to the angular momentum l (int)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_str2l</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>


<div class="viewcode-block" id="Pseudo"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo">[docs]</a><span class="k">class</span> <span class="nc">Pseudo</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="n">MSONable</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class defining the methods that must be</span>
<span class="sd">    implemented by the concrete pseudopotential classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Pseudo.as_pseudo"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.as_pseudo">[docs]</a>    <span class="k">def</span> <span class="nf">as_pseudo</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert obj into a pseudo. Accepts:</span>

<span class="sd">            * Pseudo object.</span>
<span class="sd">            * string defining a valid path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span> <span class="k">else</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Pseudo.from_file"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.from_file">[docs]</a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a :class:`Pseudo` object from filename.</span>
<span class="sd">        Note: the parser knows the concrete class that should be instanciated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PseudoParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="c1"># TODO</span>
        <span class="c1"># For the time being we check the filepath</span>
        <span class="c1"># A more robust algorithm would use md5</span>
        <span class="c1">#return self.filepath == other.filepath</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md5</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">md5</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">Z</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Z_val</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">Z_val</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l_max</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">l_max</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  summary: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  number of valence electrons: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Z_val</span><span class="p">)</span>
        <span class="c1">#FIXME: rewrite the treatment of xc, use XML specs as starting point</span>
        <span class="c1">#app(&quot;  XC correlation (ixc): %s&quot; % self._pspxc)  #FIXME</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  maximum angular momentum: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l2str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">))</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  angular momentum for local part: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">l2str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_local</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnc</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  radius for non-linear core correction: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlcc_radius</span><span class="p">)</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_hints</span><span class="p">:</span>
            <span class="n">hint_normal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hint_for_accuracy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">hint_normal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  hint for normal accuracy: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">hint_normal</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;  hints on cutoff-energy are not available&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String summarizing the most important properties.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;File basename.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">Z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The atomic number of the atom.&quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">Z_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Valence charge&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pymatgen :class:`Element`.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Element symbol.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">symbol</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">l_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximum angular momentum.&quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">l_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Angular momentum used for the local part.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isnc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if norm-conserving pseudopotential.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">NcPseudo</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ispaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if PAW pseudopotential.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">PawPseudo</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
<div class="viewcode-block" id="Pseudo.md5"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.md5">[docs]</a>    <span class="k">def</span> <span class="nf">md5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;MD5 hash value.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dojo_report</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;md5&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Dojo report without md5 entry&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_md5</span><span class="p">()</span></div>

<div class="viewcode-block" id="Pseudo.compute_md5"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.compute_md5">[docs]</a>    <span class="k">def</span> <span class="nf">compute_md5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute MD5 hash value.&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">hashlib</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">):</span>
            <span class="c1"># TODO: XML + DOJO_REPORT</span>
            <span class="c1">#raise NotImplementedError(&quot;md5 for XML files!&quot;)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we have a pseudo with a dojo_report at the end.</span>
            <span class="c1"># we compute the hash from the data before DOJO_REPORT.</span>
            <span class="c1"># else all the lines are taken.</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="n">start</span><span class="p">])</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<div class="viewcode-block" id="Pseudo.check_and_fix_dojo_md5"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.check_and_fix_dojo_md5">[docs]</a>    <span class="k">def</span> <span class="nf">check_and_fix_dojo_md5</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_dojo_report</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;md5&quot;</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;md5 found in dojo_report does not agree</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;with the computed value</span><span class="se">\n</span><span class="s2">Found </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Computed </span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">],</span> <span class="nb">hash</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_md5</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_dojo_report</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span></div>

    <span class="c1">#@abc.abstractproperty</span>
    <span class="c1">#def xc_type(self):</span>
    <span class="c1">#    &quot;&quot;&quot;XC family e.g LDA, GGA, MGGA.&quot;&quot;&quot;</span>

    <span class="c1">#@abc.abstractproperty</span>
    <span class="c1">#def xc_flavor(self):</span>
    <span class="c1">#    &quot;&quot;&quot;XC flavor e.g PW, PW91, PBE.&quot;&quot;&quot;</span>

    <span class="c1">#@property</span>
    <span class="c1">#def xc_functional(self):</span>
    <span class="c1">#    &quot;&quot;&quot;XC identifier e.g LDA-PW91, GGA-PBE, GGA-revPBE.&quot;&quot;&quot;</span>
    <span class="c1">#    return &quot;-&quot;.join([self.xc_type, self.xc_flavor])</span>

    <span class="c1">#@abc.abstractproperty</span>
    <span class="c1">#def has_soc(self):</span>
    <span class="c1">#    &quot;&quot;&quot;True if pseudo contains spin-orbit coupling.&quot;&quot;&quot;</span>

    <span class="c1">#@abc.abstractmethod</span>
    <span class="c1">#def num_of_projectors(self, l=&#39;s&#39;):</span>
    <span class="c1">#    &quot;&quot;&quot;Number of projectors for the angular channel l&quot;&quot;&quot;</span>

    <span class="c1">#@abc.abstractmethod</span>
    <span class="c1">#def generation_mode</span>
    <span class="c1">#    &quot;&quot;&quot;scalar scalar-relativistic, relativistic.&quot;&quot;&quot;</span>

    <span class="nd">@pmg_serialize</span>
<div class="viewcode-block" id="Pseudo.as_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">basename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">Z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Z</span><span class="p">,</span>
            <span class="n">Z_val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Z_val</span><span class="p">,</span>
            <span class="n">l_max</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">l_max</span><span class="p">,</span>
            <span class="n">md5</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">md5</span><span class="p">,</span>
            <span class="n">filepath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span>
        <span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Pseudo.from_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;filepath&#39;</span><span class="p">])</span>

        <span class="c1"># Consistency test based on md5</span>
        <span class="k">if</span> <span class="s2">&quot;md5&quot;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new</span><span class="o">.</span><span class="n">md5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The md5 found in file does not agree with the one in dict</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Received </span><span class="si">%s</span><span class="se">\n</span><span class="s2">Computed </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">],</span> <span class="n">new</span><span class="o">.</span><span class="n">md5</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new</span></div>

<div class="viewcode-block" id="Pseudo.as_tmpfile"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.as_tmpfile">[docs]</a>    <span class="k">def</span> <span class="nf">as_tmpfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy the pseudopotential to a temporary a file and returns a new pseudopotential object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">tempfile</span><span class="o">,</span> <span class="nn">shutil</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_dojo_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if self contains the `DOJO_REPORT` section.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span><span class="p">)</span>

<div class="viewcode-block" id="Pseudo.delta_factor"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.delta_factor">[docs]</a>    <span class="k">def</span> <span class="nf">delta_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the deltafactor [meV/natom] computed with the given accuracy.</span>
<span class="sd">        None if the `Pseudo` does not have info on the deltafactor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dojo_report</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span><span class="p">[</span><span class="s2">&quot;delta_factor&quot;</span><span class="p">][</span><span class="n">accuracy</span><span class="p">][</span><span class="s2">&quot;dfact&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="Pseudo.read_dojo_report"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.read_dojo_report">[docs]</a>    <span class="k">def</span> <span class="nf">read_dojo_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the `DOJO_REPORT` section and set the `dojo_report` attribute.</span>
<span class="sd">        returns {} if section is not present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span></div>

<div class="viewcode-block" id="Pseudo.write_dojo_report"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.write_dojo_report">[docs]</a>    <span class="k">def</span> <span class="nf">write_dojo_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a new `DOJO_REPORT` section to the pseudopotential file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">report</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span>

        <span class="n">report</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbol</span>

        <span class="k">if</span> <span class="s2">&quot;md5&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5</span>

        <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;md5 found in dojo_report does not agree</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="s2">&quot;with the computed value</span><span class="se">\n</span><span class="s2">report: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">pseudo </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">report</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">md5</span><span class="p">))</span>

        <span class="c1"># Create JSON string from report.</span>
        <span class="n">jstring</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="c1"># Read lines from file and insert jstring between the tags.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># DOJO_REPORT was not present.</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;&lt;DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">jstring</span> <span class="p">,</span> <span class="s2">&quot;&lt;/DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;/DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">jstring</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="c1">#  Write new file.</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pseudo.remove_dojo_report"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.remove_dojo_report">[docs]</a>    <span class="k">def</span> <span class="nf">remove_dojo_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the `DOJO_REPORT` section from the pseudopotential file.&quot;&quot;&quot;</span>
        <span class="c1"># Read lines from file and insert jstring between the tags.</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span>

            <span class="n">stop</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;/DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span>

            <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>

        <span class="c1"># Write new file.</span>
        <span class="k">with</span> <span class="n">FileLock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="Pseudo.hint_for_accuracy"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.hint_for_accuracy">[docs]</a>    <span class="k">def</span> <span class="nf">hint_for_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an hint object with parameters such as ecut [Ha] and</span>
<span class="sd">        aug_ratio for given accuracy. Returns None if no hint is available.</span>

<span class="sd">        Args:</span>
<span class="sd">            accuracy: [&quot;low&quot;, &quot;normal&quot;, &quot;high&quot;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dojo_report</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Hint</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span><span class="p">[</span><span class="s2">&quot;hints&quot;</span><span class="p">][</span><span class="n">accuracy</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if self provides hints on the cutoff energy.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hint_for_accuracy</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="Pseudo.open_pspsfile"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.Pseudo.open_pspsfile">[docs]</a>    <span class="k">def</span> <span class="nf">open_pspsfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls Abinit to compute the internal tables for the application of the</span>
<span class="sd">        pseudopotential part. Returns :class:`PspsFile` object providing methods</span>
<span class="sd">        to plot and analyze the data or None if file is not found or it&#39;s not readable.</span>

<span class="sd">        Args:</span>
<span class="sd">            ecut: Cutoff energy in Hartree.</span>
<span class="sd">            pawecutdg: Cutoff energy for the PAW double grid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pymatgen.io.abinit.tasks</span> <span class="kn">import</span> <span class="n">AbinitTask</span>
        <span class="kn">from</span> <span class="nn">abipy.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
        <span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">gs_input</span>
        <span class="kn">from</span> <span class="nn">abipy.electrons.psps</span> <span class="kn">import</span> <span class="n">PspsFile</span>

        <span class="c1"># Build fake structure.</span>
        <span class="n">lattice</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="n">lattice</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="p">],</span> <span class="n">coords</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ispaw</span> <span class="ow">and</span> <span class="n">pawecutdg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">pawecudg</span> <span class="o">=</span> <span class="n">ecut</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">inp</span> <span class="o">=</span> <span class="n">gs_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span>
                       <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;unpolarized&quot;</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add prtpsps = -1 to make Abinit print the PSPS.nc file and stop.</span>
        <span class="n">inp</span><span class="p">[</span><span class="s2">&quot;prtpsps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Build temporary task and run it.</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">AbinitTask</span><span class="o">.</span><span class="n">temp_shell_task</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>
        <span class="n">retcode</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">start_and_wait</span><span class="p">()</span>

        <span class="n">filepath</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;_PSPS.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Cannot find PSPS.nc file in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c1"># Open the PSPS.nc file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PspsFile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Exception while reading PSPS file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
            <span class="k">return</span> <span class="bp">None</span></div></div>


<span class="k">class</span> <span class="nc">NcPseudo</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class defining the methods that must be implemented</span>
<span class="sd">    by the concrete classes representing norm-conserving pseudopotentials.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">nlcc_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Radius at which the core charge vanish (i.e. cut-off in a.u.).</span>
<span class="sd">        Returns 0.0 if nlcc is not used.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_nlcc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the pseudo is generated with non-linear core correction.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nlcc_radius</span> <span class="o">&gt;</span> <span class="mf">0.0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rcore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Radius of the pseudization sphere in a.u.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_core</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">PawPseudo</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class that defines the methods that must be implemented</span>
<span class="sd">    by the concrete classes representing PAW pseudopotentials.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#def nlcc_radius(self):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Radius at which the core charge vanish (i.e. cut-off in a.u.).</span>
    <span class="c1">#    Returns 0.0 if nlcc is not used.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    return 0.0</span>
    <span class="c1">#</span>

    <span class="c1">#@property</span>
    <span class="c1">#def has_nlcc(self):</span>
    <span class="c1">#    &quot;&quot;&quot;True if the pseudo is generated with non-linear core correction.&quot;&quot;&quot;</span>
    <span class="c1">#    return True</span>

    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">paw_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Radius of the PAW sphere in a.u.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rcore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Alias of paw_radius.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">paw_radius</span>


<span class="k">class</span> <span class="nc">AbinitPseudo</span><span class="p">(</span><span class="n">Pseudo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An AbinitPseudo is a pseudopotential whose file contains an abinit header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            path: Filename.</span>
<span class="sd">            header: :class:`AbinitHeader` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">summary</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s2">&quot;dojo_report&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">dojo_report</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1">#self.pspcod  = header.pspcod</span>

        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">header</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="c1"># Hide these attributes since one should always use the public interface.</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summary line reported in the ABINIT header.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zatom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zion</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">l_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">l_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lloc</span>


<span class="k">class</span> <span class="nc">NcAbinitPseudo</span><span class="p">(</span><span class="n">NcPseudo</span><span class="p">,</span> <span class="n">AbinitPseudo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Norm-conserving pseudopotential in the Abinit format.&quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summary</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zatom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of valence electrons.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zion</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">l_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lmax</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">l_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lloc</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nlcc_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rchrg</span>


<span class="k">class</span> <span class="nc">PawAbinitPseudo</span><span class="p">(</span><span class="n">PawPseudo</span><span class="p">,</span> <span class="n">AbinitPseudo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Paw pseudopotential in the Abinit format.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">paw_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_r_cut</span>

    <span class="c1">#def orbitals(self):</span>


<span class="c1">#class Hint(namedtuple(&quot;Hint&quot;, &quot;ecut aug_ratio&quot;)):</span>
<span class="k">class</span> <span class="nc">Hint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Suggested value for the cutoff energy [Hartree units]</span>
<span class="sd">    and the cutoff energy for the dense grid (only for PAW pseudos)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ecut</span> <span class="o">=</span> <span class="n">ecut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pawecutdg</span> <span class="o">=</span> <span class="n">ecut</span> <span class="k">if</span> <span class="n">pawecutdg</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">pawecutdg</span>

    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ecut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pawecutdg</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@&quot;</span><span class="p">)})</span>


<span class="k">def</span> <span class="nf">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">key_nums</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to parse formatted text structured like:</span>

<span class="sd">    value1 value2 ... sep key1, key2 ...</span>

<span class="sd">    key_nums is a list giving the number of keys for each line. 0 if line should be skipped.</span>
<span class="sd">    sep is a string denoting the character that separates the keys from the value (None if</span>
<span class="sd">    no separator is present).</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict{key1 : value1, key2 : value2, ...}</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError if parsing fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">lines</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key_nums</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
        <span class="n">key_nums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">key_nums</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_nums</span><span class="p">):</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;lines = </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> key_num =  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">key_nums</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">nk</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">key_nums</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nk</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="n">nk</span><span class="p">],</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">nk</span><span class="p">:])</span>
        <span class="c1"># Sanitize keys: In some case we might string in for  foo[,bar]</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">check</span> <span class="o">!=</span> <span class="n">sep</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expecting separator </span><span class="si">%s</span><span class="s2">, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">check</span><span class="p">))</span>
            <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;line: </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> len(keys) != len(value)</span><span class="se">\n</span><span class="s2">keys: </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> values:  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">kwargs</span>


<span class="k">class</span> <span class="nc">AbinitHeader</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dictionary whose keys can be also accessed as attributes.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Default behaviour</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AbinitHeader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try in the dictionary.</span>
                <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_int_from_str</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert string into integer</span>

<span class="sd">    Raise:</span>
<span class="sd">        TypeError if string is not a valid integer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">float_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="n">int_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">float_num</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">float_num</span> <span class="o">==</span> <span class="n">int_num</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">int_num</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Needed to handle pseudos with fractional charge</span>
        <span class="n">int_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">float_num</span><span class="p">)</span>
        <span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Converting float </span><span class="si">%s</span><span class="s2"> to int </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">float_num</span><span class="p">,</span> <span class="n">int_num</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">int_num</span>
        <span class="c1">#raise TypeError(&quot;Cannot convert string %s to int&quot; % string)</span>


<span class="k">class</span> <span class="nc">NcAbinitHeader</span><span class="p">(</span><span class="n">AbinitHeader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The abinit header found in the NC pseudopotential files.&quot;&quot;&quot;</span>
    <span class="n">_attr_desc</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;att&quot;</span><span class="p">,</span> <span class="s2">&quot;default astype&quot;</span><span class="p">)</span>

    <span class="n">_VARS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Mandatory</span>
        <span class="s2">&quot;zatom&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_int_from_str</span><span class="p">),</span>
        <span class="s2">&quot;zion&quot;</span>         <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;pspdat&quot;</span>       <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;pspcod&quot;</span>       <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;pspxc&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;lmax&quot;</span>         <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;lloc&quot;</span>         <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;r2well&quot;</span>       <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;mmax&quot;</span>         <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="c1"># Optional variables for non linear-core correction. HGH does not have it.</span>
        <span class="s2">&quot;rchrg&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>  <span class="nb">float</span><span class="p">),</span>  <span class="c1"># radius at which the core charge vanish (i.e. cut-off in a.u.)</span>
        <span class="s2">&quot;fchrg&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>  <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;qchrg&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span>  <span class="nb">float</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">del</span> <span class="n">_attr_desc</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NcAbinitHeader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="c1"># APE uses llocal instead of lloc.</span>
        <span class="k">if</span> <span class="s2">&quot;llocal&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;lloc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;llocal&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">_VARS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">default</span><span class="p">,</span> <span class="n">astype</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">desc</span><span class="o">.</span><span class="n">astype</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Attribute </span><span class="si">%s</span><span class="s2"> must be specified&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Conversion Error for key </span><span class="si">%s</span><span class="s2">, value </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Add dojo_report</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1">#if kwargs:</span>
        <span class="c1">#    raise RuntimeError(&quot;kwargs should be empty but got %s&quot; % str(kwargs))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fhi_header</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the FHI abinit header.&quot;&quot;&quot;</span>
        <span class="c1"># Example:</span>
        <span class="c1"># Troullier-Martins psp for element  Sc        Thu Oct 27 17:33:22 EDT 1994</span>
        <span class="c1">#  21.00000   3.00000    940714                zatom, zion, pspdat</span>
        <span class="c1">#    1    1    2    0      2001    .00000      pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1"># 1.80626423934776     .22824404341771    1.17378968127746   rchrg,fchrg,qchrg</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The last record with rchrg ... seems to be optional.</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NcAbinitHeader</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">hgh_header</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the HGH abinit header.&quot;&quot;&quot;</span>
        <span class="c1"># Example:</span>
        <span class="c1">#Hartwigsen-Goedecker-Hutter psp for Ne,  from PRB58, 3641 (1998)</span>
        <span class="c1">#   10   8  010605 zatom,zion,pspdat</span>
        <span class="c1"># 3 1   1 0 2001 0  pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NcAbinitHeader</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gth_header</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the GTH abinit header.&quot;&quot;&quot;</span>
        <span class="c1"># Example:</span>
        <span class="c1">#Goedecker-Teter-Hutter  Wed May  8 14:27:44 EDT 1996</span>
        <span class="c1">#1   1   960508                     zatom,zion,pspdat</span>
        <span class="c1">#2   1   0    0    2001    0.       pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1">#0.2000000 -4.0663326  0.6778322 0 0     rloc, c1, c2, c3, c4</span>
        <span class="c1">#0 0 0                              rs, h1s, h2s</span>
        <span class="c1">#0 0                                rp, h1p</span>
        <span class="c1">#  1.36 .2   0.6                    rcutoff, rloc</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NcAbinitHeader</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">oncvpsp_header</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the ONCVPSP abinit header.&quot;&quot;&quot;</span>
        <span class="c1"># Example</span>
        <span class="c1">#Li    ONCVPSP  r_core=  2.01  3.02</span>
        <span class="c1">#      3.0000      3.0000      140504    zatom,zion,pspd</span>
        <span class="c1">#     8     2     1     4   600     0    pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1">#  5.99000000  0.00000000  0.00000000    rchrg fchrg qchrg</span>
        <span class="c1">#     2     2     0     0     0    nproj</span>
        <span class="c1">#     0                 extension_switch</span>
        <span class="c1">#   0                        -2.5000025868368D+00 -1.2006906995331D+00</span>
        <span class="c1">#     1  0.0000000000000D+00  0.0000000000000D+00  0.0000000000000D+00</span>
        <span class="c1">#     2  1.0000000000000D-02  4.4140499497377D-02  1.9909081701712D-02</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;pspdat&#39;</span><span class="p">:</span> <span class="n">header</span><span class="p">[</span><span class="s1">&#39;pspd&#39;</span><span class="p">]})</span>
        <span class="n">header</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;pspd&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to read the dojo report for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">NcAbinitHeader</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">tm_header</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the TM abinit header.&quot;&quot;&quot;</span>
        <span class="c1"># Example:</span>
        <span class="c1">#Troullier-Martins psp for element Fm         Thu Oct 27 17:28:39 EDT 1994</span>
        <span class="c1">#100.00000  14.00000    940714                zatom, zion, pspdat</span>
        <span class="c1">#   1    1    3    0      2001    .00000      pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1">#   0   4.085   6.246    0   2.8786493        l,e99.0,e99.9,nproj,rcpsp</span>
        <span class="c1">#   .00000000    .0000000000    .0000000000    .00000000   rms,ekb1,ekb2,epsatm</span>
        <span class="c1">#   1   3.116   4.632    1   3.4291849        l,e99.0,e99.9,nproj,rcpsp</span>
        <span class="c1">#   .00000000    .0000000000    .0000000000    .00000000   rms,ekb1,ekb2,epsatm</span>
        <span class="c1">#   2   4.557   6.308    1   2.1865358        l,e99.0,e99.9,nproj,rcpsp</span>
        <span class="c1">#   .00000000    .0000000000    .0000000000    .00000000   rms,ekb1,ekb2,epsatm</span>
        <span class="c1">#   3  23.251  29.387    1   2.4776730        l,e99.0,e99.9,nproj,rcpsp</span>
        <span class="c1">#   .00000000    .0000000000    .0000000000    .00000000   rms,ekb1,ekb2,epsatm</span>
        <span class="c1">#   3.62474762267880     .07409391739104    3.07937699839200   rchrg,fchrg,qchrg</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lineno</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Read lmax.</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">pspcod</span><span class="p">,</span> <span class="n">pspxc</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">lloc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">mmax</span><span class="p">,</span> <span class="n">r2well</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
                <span class="c1">#if tokens[-1].strip() != &quot;pspcod,pspxc,lmax,lloc,mmax,r2well&quot;:</span>
                <span class="c1">#    raise RuntimeError(&quot;%s: Invalid line\n %s&quot;  % (filename, line))</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="k">break</span>

        <span class="c1"># TODO</span>
        <span class="c1"># Parse the section with the projectors.</span>
        <span class="c1">#0   4.085   6.246    0   2.8786493        l,e99.0,e99.9,nproj,rcpsp</span>
        <span class="c1">#.00000000    .0000000000    .0000000000    .00000000   rms,ekb1,ekb2,epsatm</span>
        <span class="n">projectors</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">lmax</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">proj_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">,]</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">proj_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">proj_info</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">projectors</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;l&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">d</span>

        <span class="c1"># Add the last line with info on nlcc.</span>
        <span class="n">header</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">NcAbinitHeader</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PawAbinitHeader</span><span class="p">(</span><span class="n">AbinitHeader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The abinit header found in the PAW pseudopotential files.&quot;&quot;&quot;</span>
    <span class="n">_attr_desc</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;att&quot;</span><span class="p">,</span> <span class="s2">&quot;default astype&quot;</span><span class="p">)</span>

    <span class="n">_VARS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;zatom&quot;</span>           <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">_int_from_str</span><span class="p">),</span>
        <span class="s2">&quot;zion&quot;</span>            <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;pspdat&quot;</span>          <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;pspcod&quot;</span>          <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;pspxc&quot;</span>           <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;lmax&quot;</span>            <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;lloc&quot;</span>            <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;mmax&quot;</span>            <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;r2well&quot;</span>          <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
        <span class="s2">&quot;pspfmt&quot;</span>          <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span>
        <span class="s2">&quot;creatorID&quot;</span>       <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;basis_size&quot;</span>      <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;lmn_size&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;orbitals&quot;</span>        <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span>
        <span class="s2">&quot;number_of_meshes&quot;</span><span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;r_cut&quot;</span>           <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="c1"># r_cut(PAW) in the header</span>
        <span class="s2">&quot;shape_type&quot;</span>      <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;rshape&quot;</span>          <span class="p">:</span> <span class="n">_attr_desc</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">del</span> <span class="n">_attr_desc</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PawAbinitHeader</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">desc</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_VARS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">default</span><span class="p">,</span> <span class="n">astype</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">desc</span><span class="o">.</span><span class="n">astype</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Attribute </span><span class="si">%s</span><span class="s2"> must be specified&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">astype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Conversion Error for key </span><span class="si">%s</span><span class="s2">, with value </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;kwargs should be empty but got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">paw_header</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the PAW abinit header.&quot;&quot;&quot;</span>
        <span class="c1">#Paw atomic data for element Ni - Generated by AtomPAW (N. Holzwarth) + AtomPAW2Abinit v3.0.5</span>
        <span class="c1">#  28.000  18.000 20061204               : zatom,zion,pspdat</span>
        <span class="c1">#  7  7  2 0   350 0.                    : pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1"># paw3 1305                              : pspfmt,creatorID</span>
        <span class="c1">#  5 13                                  : basis_size,lmn_size</span>
        <span class="c1"># 0 0 1 1 2                              : orbitals</span>
        <span class="c1"># 3                                      : number_of_meshes</span>
        <span class="c1"># 1 3  350 1.1803778368E-05 3.5000000000E-02 : mesh 1, type,size,rad_step[,log_step]</span>
        <span class="c1"># 2 1  921 2.500000000000E-03                : mesh 2, type,size,rad_step[,log_step]</span>
        <span class="c1"># 3 3  391 1.1803778368E-05 3.5000000000E-02 : mesh 3, type,size,rad_step[,log_step]</span>
        <span class="c1">#  2.3000000000                          : r_cut(SPH)</span>
        <span class="c1"># 2 0.</span>

        <span class="c1"># Example</span>
        <span class="c1">#C  (US d-loc) - PAW data extracted from US-psp (D.Vanderbilt) - generated by USpp2Abinit v2.3.0</span>
        <span class="c1">#   6.000   4.000 20090106               : zatom,zion,pspdat</span>
        <span class="c1">#  7 11  1 0   560 0.                    : pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1"># paw4 2230                              : pspfmt,creatorID</span>
        <span class="c1">#  4  8                                  : basis_size,lmn_size</span>
        <span class="c1"># 0 0 1 1                                : orbitals</span>
        <span class="c1"># 5                                      : number_of_meshes</span>
        <span class="c1"># 1 2  560 1.5198032759E-04 1.6666666667E-02 : mesh 1, type,size,rad_step[,log_step]</span>
        <span class="c1"># 2 2  556 1.5198032759E-04 1.6666666667E-02 : mesh 2, type,size,rad_step[,log_step]</span>
        <span class="c1"># 3 2  576 1.5198032759E-04 1.6666666667E-02 : mesh 3, type,size,rad_step[,log_step]</span>
        <span class="c1"># 4 2  666 1.5198032759E-04 1.6666666667E-02 : mesh 4, type,size,rad_step[,log_step]</span>
        <span class="c1"># 5 2  673 1.5198032759E-04 1.6666666667E-02 : mesh 5, type,size,rad_step[,log_step]</span>
        <span class="c1">#  1.5550009124                          : r_cut(PAW)</span>
        <span class="c1"># 3 0.                                   : shape_type,rshape</span>

        <span class="c1">#Paw atomic data for element Si - Generated by atompaw v3.0.1.3 &amp; AtomPAW2Abinit v3.3.1</span>
        <span class="c1">#  14.000   4.000 20120814               : zatom,zion,pspdat</span>
        <span class="c1">#  7      11  1 0   663 0.               : pspcod,pspxc,lmax,lloc,mmax,r2well</span>
        <span class="c1"># paw5 1331                              : pspfmt,creatorID</span>
        <span class="c1">#  4  8                                  : basis_size,lmn_size</span>
        <span class="c1"># 0 0 1 1                                : orbitals</span>
        <span class="c1"># 5                                      : number_of_meshes</span>
        <span class="c1"># 1 2  663 8.2129718540404674E-04 1.1498160595656655E-02 : mesh 1, type,size,rad_step[,log_step]</span>
        <span class="c1"># 2 2  658 8.2129718540404674E-04 1.1498160595656655E-02 : mesh 2, type,size,rad_step[,log_step]</span>
        <span class="c1"># 3 2  740 8.2129718540404674E-04 1.1498160595656655E-02 : mesh 3, type,size,rad_step[,log_step]</span>
        <span class="c1"># 4 2  819 8.2129718540404674E-04 1.1498160595656655E-02 : mesh 4, type,size,rad_step[,log_step]</span>
        <span class="c1"># 5 2  870 8.2129718540404674E-04 1.1498160595656655E-02 : mesh 5, type,size,rad_step[,log_step]</span>
        <span class="c1">#  1.5669671236                          : r_cut(PAW)</span>
        <span class="c1"># 2 0.                                   : shape_type,rshape</span>
        <span class="n">supported_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;paw3&quot;</span><span class="p">,</span> <span class="s2">&quot;paw4&quot;</span><span class="p">,</span> <span class="s2">&quot;paw5&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ppdesc</span><span class="o">.</span><span class="n">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">supported_formats</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;format </span><span class="si">%s</span><span class="s2"> not in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ppdesc</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">supported_formats</span><span class="p">))</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
        <span class="c1"># TODO</span>
        <span class="c1"># Parse orbitals and number of meshes.</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;orbitals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;number_of_meshes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_meshes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#print filename, header</span>

        <span class="c1"># Skip meshes =</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="o">+</span><span class="n">num_meshes</span><span class="p">:]</span>
        <span class="c1">#for midx in range(num_meshes):</span>
        <span class="c1">#    l = midx + 1</span>

        <span class="c1">#print lines[0]</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;r_cut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#print lines[1]</span>
        <span class="n">header</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_dict_from_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">))</span>

        <span class="n">report</span> <span class="o">=</span> <span class="n">DojoReport</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;dojo_report&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report</span>

        <span class="c1">#print(&quot;PAW header\n&quot;, header)</span>
        <span class="k">return</span> <span class="n">PawAbinitHeader</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PseudoParserError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base Error class for the exceptions raised by :class:`PseudoParser`&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">PseudoParser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Responsible for parsing pseudopotential files and returning pseudopotential objects.</span>

<span class="sd">    Usage::</span>

<span class="sd">        pseudo = PseudoParser().parse(&quot;filename&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">PseudoParserError</span>

    <span class="c1"># Supported values of pspcod</span>
    <span class="n">ppdesc</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;ppdesc&quot;</span><span class="p">,</span> <span class="s2">&quot;pspcod name psp_type format&quot;</span><span class="p">)</span>

    <span class="c1"># TODO Recheck</span>
    <span class="n">_PSPCODES</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span> <span class="p">{</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;TM&quot;</span><span class="p">,</span>  <span class="s2">&quot;NC&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;GTH&quot;</span><span class="p">,</span>  <span class="s2">&quot;NC&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="mi">3</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;HGH&quot;</span><span class="p">,</span> <span class="s2">&quot;NC&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="c1">#4: ppdesc(4, &quot;NC&quot;,     , None),</span>
        <span class="c1">#5: ppdesc(5, &quot;NC&quot;,     , None),</span>
        <span class="mi">6</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;FHI&quot;</span><span class="p">,</span> <span class="s2">&quot;NC&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="mi">7</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;PAW_abinit_text&quot;</span><span class="p">,</span> <span class="s2">&quot;PAW&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
        <span class="mi">8</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;ONCVPSP&quot;</span><span class="p">,</span> <span class="s2">&quot;NC&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
       <span class="mi">10</span><span class="p">:</span> <span class="n">ppdesc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;HGHK&quot;</span><span class="p">,</span> <span class="s2">&quot;NC&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
    <span class="p">})</span>
    <span class="k">del</span> <span class="n">ppdesc</span>
    <span class="c1"># renumber functionals from oncvpsp todo confrim that 3 is 2</span>
    <span class="n">_FUNCTIONALS</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Wigner&#39;</span><span class="p">},</span>
                    <span class="mi">2</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;HL&#39;</span><span class="p">},</span>
                    <span class="mi">3</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;PWCA&#39;</span><span class="p">},</span>
                    <span class="mi">4</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;PBE&#39;</span><span class="p">}}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># List of files that have been parsed succesfully.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_paths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># List of files that could not been parsed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wrong_paths</span>  <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">scan_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">exclude_exts</span><span class="o">=</span><span class="p">(),</span> <span class="n">exclude_fnames</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the files contained in directory dirname.</span>

<span class="sd">        Args:</span>
<span class="sd">            dirname: directory path</span>
<span class="sd">            exclude_exts: list of file extensions that should be skipped.</span>
<span class="sd">            exclude_fnames: list of file names that should be skipped.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of pseudopotential objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exclude_exts</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
                <span class="n">exclude_exts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>  <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Exclude files depending on the extension.</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ext</span> <span class="ow">in</span> <span class="n">exclude_exts</span> <span class="ow">or</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">exclude_fnames</span> <span class="ow">or</span>
                <span class="n">fname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span> <span class="k">continue</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="c1"># Parse the file and generate the pseudo.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pseudo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">pseudo</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">pseudo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pseudo</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parsed_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_wrong_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pseudos</span>

    <span class="k">def</span> <span class="nf">read_ppdesc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the pseudopotential descriptor from file filename.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pseudopotential descriptor. None if filename is not a valid pseudopotential file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            `PseudoParserError` if fileformat is not supported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;XML pseudo not supported yet&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume file with the abinit header.</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">_read_nlines</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">lineno</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">pspcod</span><span class="p">,</span> <span class="n">pspxc</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Cannot parse pspcod, pspxc in line</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">None</span>

                    <span class="c1">#if tokens[-1].strip().replace(&quot; &quot;,&quot;&quot;) not in [&quot;pspcod,pspxc,lmax,lloc,mmax,r2well&quot;,</span>
                    <span class="c1">#                              &quot;pspcod,pspxc,lmax,llocal,mmax,r2well&quot;]:</span>
                    <span class="c1">#    raise self.Error(&quot;%s: Invalid line\n %s&quot;  % (filename, line))</span>
                    <span class="c1">#    return None</span>

                    <span class="k">if</span> <span class="n">pspcod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PSPCODES</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Don&#39;t know how to handle pspcod </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pspcod</span><span class="p">))</span>

                    <span class="n">ppdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PSPCODES</span><span class="p">[</span><span class="n">pspcod</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">pspcod</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                        <span class="c1"># PAW -&gt; need to know the format pspfmt</span>
                        <span class="n">tokens</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">lineno</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">pspfmt</span><span class="p">,</span> <span class="n">creatorID</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                        <span class="c1">#if tokens[-1].strip() != &quot;pspfmt,creatorID&quot;:</span>
                        <span class="c1">#    raise self.Error(&quot;%s: Invalid line\n %s&quot; % (filename, line))</span>
                        <span class="c1">#    return None</span>

                        <span class="n">ppdesc</span> <span class="o">=</span> <span class="n">ppdesc</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">format</span> <span class="o">=</span> <span class="n">pspfmt</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">ppdesc</span>

            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read and parse a pseudopotential file. Main entry point for client code.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pseudopotential object or None if filename is not a valid pseudopotential file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># Only PAW supports XML at present.</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.xml&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">PawXmlSetup</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">ppdesc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_ppdesc</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ppdesc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">psp_type</span> <span class="o">=</span> <span class="n">ppdesc</span><span class="o">.</span><span class="n">psp_type</span>

        <span class="n">parsers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;FHI&quot;</span>            <span class="p">:</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">fhi_header</span><span class="p">,</span>
            <span class="s2">&quot;GTH&quot;</span>            <span class="p">:</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">gth_header</span><span class="p">,</span>
            <span class="s2">&quot;TM&quot;</span>             <span class="p">:</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">tm_header</span><span class="p">,</span>
            <span class="s2">&quot;HGH&quot;</span>            <span class="p">:</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">hgh_header</span><span class="p">,</span>
            <span class="s2">&quot;HGHK&quot;</span>           <span class="p">:</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">hgh_header</span><span class="p">,</span>
            <span class="s2">&quot;ONCVPSP&quot;</span>        <span class="p">:</span> <span class="n">NcAbinitHeader</span><span class="o">.</span><span class="n">oncvpsp_header</span><span class="p">,</span>
            <span class="s2">&quot;PAW_abinit_text&quot;</span><span class="p">:</span> <span class="n">PawAbinitHeader</span><span class="o">.</span><span class="n">paw_header</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">parsers</span><span class="p">[</span><span class="n">ppdesc</span><span class="o">.</span><span class="n">name</span><span class="p">](</span><span class="n">path</span><span class="p">,</span> <span class="n">ppdesc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">straceback</span><span class="p">())</span>

        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">psp_type</span> <span class="o">==</span> <span class="s2">&quot;NC&quot;</span><span class="p">:</span>
            <span class="n">pseudo</span> <span class="o">=</span> <span class="n">NcAbinitPseudo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">psp_type</span> <span class="o">==</span> <span class="s2">&quot;PAW&quot;</span><span class="p">:</span>
            <span class="n">pseudo</span> <span class="o">=</span> <span class="n">PawAbinitPseudo</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;psp_type not in [NC, PAW]&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pseudo</span>


<span class="c1">#TODO use RadialFunction from pseudo_dojo.</span>
<span class="k">class</span> <span class="nc">RadialFunction</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;RadialFunction&quot;</span><span class="p">,</span> <span class="s2">&quot;mesh values&quot;</span><span class="p">)):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PawXmlSetup</span><span class="p">(</span><span class="n">Pseudo</span><span class="p">,</span> <span class="n">PawPseudo</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="c1"># FIXME</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dojo_report</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="c1"># Get the XML root (this trick is used to that the object is pickleable).</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>

        <span class="c1"># Get the version of the XML format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paw_setup_version</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">)</span>

        <span class="c1"># Info on the atom.</span>
        <span class="n">atom_attrib</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;atom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">attrib</span>

        <span class="c1">#self._symbol = atom_attrib[&quot;symbol&quot;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zatom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">atom_attrib</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="p">[</span><span class="n">atom_attrib</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">],</span> <span class="n">atom_attrib</span><span class="p">[</span><span class="s2">&quot;valence&quot;</span><span class="p">]])</span>

        <span class="c1">#xc_info = root.find(&quot;atom&quot;).attrib</span>
        <span class="c1">#self.xc_type, self.xc_name  = xc_info[&quot;type&quot;], xc_info[&quot;name&quot;]</span>
        <span class="c1">#self.ae_energy = {k: float(v) for k,v in root.find(&quot;ae_energy&quot;).attrib.items()}</span>

        <span class="c1"># Old XML files do not define this field!</span>
        <span class="c1"># In this case we set the PAW radius to None.</span>
        <span class="c1">#self._paw_radius = float(root.find(&quot;PAW_radius&quot;).attrib[&quot;rpaw&quot;])</span>

        <span class="n">pawr_element</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;PAW_radius&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paw_radius</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">pawr_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paw_radius</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pawr_element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;rpaw&quot;</span><span class="p">])</span>

        <span class="c1">#&lt;valence_states&gt;</span>
        <span class="c1">#  &lt;state n=&quot;2&quot; l=&quot;0&quot; f=&quot;2&quot;  rc=&quot;1.10&quot; e=&quot;-0.6766&quot; id=&quot;N-2s&quot;/&gt;</span>
        <span class="c1">#  &lt;state n=&quot;2&quot; l=&quot;1&quot; f=&quot;3&quot;  rc=&quot;1.10&quot; e=&quot;-0.2660&quot; id=&quot;N-2p&quot;/&gt;</span>
        <span class="c1">#  &lt;state       l=&quot;0&quot;        rc=&quot;1.10&quot; e=&quot; 0.3234&quot; id=&quot;N-s1&quot;/&gt;</span>
        <span class="c1">#  &lt;state       l=&quot;1&quot;        rc=&quot;1.10&quot; e=&quot; 0.7340&quot; id=&quot;N-p1&quot;/&gt;</span>
        <span class="c1">#  &lt;state       l=&quot;2&quot;        rc=&quot;1.10&quot; e=&quot; 0.0000&quot; id=&quot;N-d1&quot;/&gt;</span>
        <span class="c1">#&lt;/valence_states&gt;</span>
        <span class="c1">#</span>
        <span class="c1"># The valence_states element contains several state elements.</span>
        <span class="c1"># For this setup, the first two lines describe bound eigenstates</span>
        <span class="c1"># with occupation numbers and principal quantum numbers.</span>
        <span class="c1"># Notice, that the three additional unbound states should have no f and n attributes.</span>
        <span class="c1"># In this way, we know that only the first two bound states (with f and n attributes)</span>
        <span class="c1"># should be used for constructing an initial guess for the wave functions.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">valence_states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;valence_states&quot;</span><span class="p">):</span>
            <span class="n">attrib</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">attrib</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence_states</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valence_states</span><span class="p">[</span><span class="n">attrib</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">attrib</span>
        <span class="c1">#print(self.valence_states)</span>

        <span class="c1"># Parse the radial grids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rad_grids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;radial_grid&quot;</span><span class="p">):</span>
            <span class="n">grid_params</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">grid_params</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">gid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad_grids</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">rad_grids</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_grid</span><span class="p">(</span><span class="n">grid_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return state is pickled as the contents for the instance.</span>

<span class="sd">        In this case we just remove the XML root element process since Element object cannot be pickled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;_root&quot;</span><span class="p">]}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">xml.etree</span> <span class="kn">import</span> <span class="n">cElementTree</span> <span class="k">as</span> <span class="n">Et</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">Et</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zatom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Z_val</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of valence electrons.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence</span>

    <span class="c1"># FIXME</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">l_max</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximum angular momentum.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">l_local</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Angular momentum used for the local part.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String summarizing the most important properties.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">paw_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paw_radius</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eval_grid</span><span class="p">(</span><span class="n">grid_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function receives a dictionary with the parameters defining the</span>
<span class="sd">        radial mesh and returns a `ndarray` with the mesh</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">grid_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eq&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">istart</span><span class="p">,</span> <span class="n">iend</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;istart&quot;</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">grid_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iend&quot;</span><span class="p">))</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">istart</span><span class="p">,</span> <span class="n">iend</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">eq</span> <span class="o">==</span> <span class="s1">&#39;r=a*exp(d*i)&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">eq</span> <span class="o">==</span> <span class="s1">&#39;r=a*i/(n-i)&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">eq</span> <span class="o">==</span> <span class="s1">&#39;r=a*(exp(d*i)-1)&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">eq</span> <span class="o">==</span> <span class="s1">&#39;r=d*i&#39;</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">])</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">eq</span> <span class="o">==</span> <span class="s1">&#39;r=(i/n+a)^5/a-a^4&#39;</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">grid_params</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">])</span>
            <span class="n">mesh</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">/</span> <span class="n">n</span> <span class="o">+</span> <span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">5</span> <span class="o">/</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown grid type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">eq</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_radfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the first occurence of func_name in the XML file.&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad_grids</span><span class="p">[</span><span class="n">grid</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>

    <span class="k">def</span> <span class="nf">_parse_all_radfuncs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse all the nodes with tag func_name in the XML file.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">func_name</span><span class="p">):</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">rad_grids</span><span class="p">[</span><span class="n">grid</span><span class="p">],</span> <span class="n">values</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ae_core_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The all-electron radial density.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ae_core_density</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_radfunc</span><span class="p">(</span><span class="s2">&quot;ae_core_density&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ae_core_density</span> <span class="o">=</span> <span class="n">RadialFunction</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ae_core_density</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pseudo_core_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The pseudized radial density.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_core_density</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attrib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_radfunc</span><span class="p">(</span><span class="s2">&quot;pseudo_core_density&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_core_density</span> <span class="o">=</span> <span class="n">RadialFunction</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_core_density</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ae_partial_waves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the AE partial waves indexed by state.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ae_partial_waves</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ae_partial_waves</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_all_radfuncs</span><span class="p">(</span><span class="s2">&quot;ae_partial_wave&quot;</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
                <span class="n">val_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ae_partial_waves</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">RadialFunction</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="c1">#print(&quot;val_state&quot;, val_state)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ae_partial_waves</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pseudo_partial_waves</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the pseudo partial waves indexed by state.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_partial_waves</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_partial_waves</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_all_radfuncs</span><span class="p">(</span><span class="s2">&quot;pseudo_partial_wave&quot;</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
                <span class="n">val_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_partial_waves</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">RadialFunction</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudo_partial_waves</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">projector_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary with the PAW projectors indexed by state.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projector_functions</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_projector_functions</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">attrib</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_all_radfuncs</span><span class="p">(</span><span class="s2">&quot;projector_function&quot;</span><span class="p">):</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
                <span class="n">val_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">valence_states</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_projector_functions</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">RadialFunction</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_projector_functions</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_densities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the PAW densities.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r [Bohr]&#39;</span><span class="p">)</span>
        <span class="c1">#ax.set_ylabel(&#39;density&#39;)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">den_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;ae_core_density&quot;</span><span class="p">,</span> <span class="s2">&quot;pseudo_core_density&quot;</span><span class="p">]):</span>
            <span class="n">rden</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">den_name</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;$n_c$&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">tilde{n}_c$&quot;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rden</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rden</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">rden</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_waves</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the AE and the pseudo partial waves.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r [Bohr]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$r\phi,</span><span class="se">\\</span><span class="s2">, r</span><span class="se">\\</span><span class="s2">tilde\phi\, [Bohr]^{-</span><span class="se">\\</span><span class="s2">frac{1}{2}}$&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paw_radius</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="c1">#ax.annotate(&quot;$r_c$&quot;, xy=(self.paw_radius + 0.1, 0.1))</span>

        <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">rfunc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudo_partial_waves</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rfunc</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rfunc</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">rfunc</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;PS-WAVE: &quot;</span> <span class="o">+</span> <span class="n">state</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">rfunc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ae_partial_waves</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rfunc</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rfunc</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">rfunc</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AE-WAVE: &quot;</span> <span class="o">+</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_projectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the PAW projectors.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Projectors&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;r [Bohr]&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$r</span><span class="se">\\</span><span class="s2">tilde p\, [Bohr]^{-</span><span class="se">\\</span><span class="s2">frac{1}{2}}$&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paw_radius</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
        <span class="c1">#ax.annotate(&quot;$r_c$&quot;, xy=(self.paw_radius + 0.1, 0.1))</span>

        <span class="k">for</span> <span class="n">state</span><span class="p">,</span> <span class="n">rfunc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projector_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rfunc</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">rfunc</span><span class="o">.</span><span class="n">mesh</span> <span class="o">*</span> <span class="n">rfunc</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;TPROJ: &quot;</span> <span class="o">+</span> <span class="n">state</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="c1">#@add_fig_kwargs</span>
    <span class="c1">#def plot_potentials(self, **kwargs):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#        ================  ==============================================================</span>
    <span class="c1">#        kwargs            Meaning</span>
    <span class="c1">#        ================  ==============================================================</span>
    <span class="c1">#        title             Title of the plot (Default: None).</span>
    <span class="c1">#        show              True to show the figure (Default).</span>
    <span class="c1">#        savefig           &#39;abc.png&#39; or &#39;abc.eps&#39; to save the figure to a file.</span>
    <span class="c1">#        ================  ==============================================================</span>

    <span class="c1">#    Returns:</span>
    <span class="c1">#        `matplotlib` figure</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    title = kwargs.pop(&quot;title&quot;, &quot;Potentials&quot;)</span>
    <span class="c1">#    show = kwargs.pop(&quot;show&quot;, True)</span>
    <span class="c1">#    savefig = kwargs.pop(&quot;savefig&quot;, None)</span>

    <span class="c1">#    import matplotlib.pyplot as plt</span>

    <span class="c1">#    fig = plt.figure()</span>

    <span class="c1">#    ax = fig.add_subplot(1,1,1)</span>
    <span class="c1">#    ax.grid(True)</span>
    <span class="c1">#    ax.set_xlabel(&#39;r [Bohr]&#39;)</span>
    <span class="c1">#    ax.set_ylabel(&#39;density&#39;)</span>
    <span class="c1">#    ax.axvline(x=self.paw_radius, linewidth=2, color=&#39;k&#39;, linestyle=&quot;--&quot;)</span>
    <span class="c1">#    ax.annotate(&quot;$r_c$&quot;, xy=(self.paw_radius + 0.1, 0.1))</span>

    <span class="c1">#    for state, rfunc in self.potentials.items():</span>
    <span class="c1">#        ax.plot(rfunc.mesh, rfunc.values, label=&quot;TPROJ: &quot; + state)</span>

    <span class="c1">#    ax.legend(loc=&quot;best&quot;)</span>

    <span class="c1">#    if title is not None: fig.suptitle(title)</span>
    <span class="c1">#    if show: plt.show()</span>
    <span class="c1">#    if savefig: fig.savefig(savefig)</span>
    <span class="c1">#    return fig</span>


<div class="viewcode-block" id="PseudoTable"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable">[docs]</a><span class="k">class</span> <span class="nc">PseudoTable</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">MSONable</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the pseudopotentials from the element table.</span>
<span class="sd">    Individidual elements are accessed by name, symbol or atomic number.</span>

<span class="sd">    For example, the following all retrieve iron:</span>

<span class="sd">    print elements[26]</span>
<span class="sd">    Fe</span>
<span class="sd">    print elements.Fe</span>
<span class="sd">    Fe</span>
<span class="sd">    print elements.symbol(&#39;Fe&#39;)</span>
<span class="sd">    Fe</span>
<span class="sd">    print elements.name(&#39;iron&#39;)</span>
<span class="sd">    Fe</span>
<span class="sd">    print elements.isotope(&#39;Fe&#39;)</span>
<span class="sd">    Fe</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PseudoTable.as_table"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.as_table">[docs]</a>    <span class="k">def</span> <span class="nf">as_table</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an instance of :class:`PseudoTable` from the iterable items.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span> <span class="k">return</span> <span class="n">items</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">items</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PseudoTable.from_dir"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.from_dir">[docs]</a>    <span class="k">def</span> <span class="nf">from_dir</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">exts</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="s2">&quot;_*&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all pseudos in the directory tree starting from top.</span>

<span class="sd">        Args:</span>
<span class="sd">            top: Top of the directory tree</span>
<span class="sd">            exts: List of files extensions. if exts == &quot;all_files&quot;</span>
<span class="sd">                    we try to open all files in top</span>
<span class="sd">            exclude_dirs: Wildcard used to exclude directories.</span>

<span class="sd">        return: :class:`PseudoTable` sorted by atomic number Z.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">exts</span> <span class="o">==</span> <span class="s2">&quot;all_files&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">top</span><span class="p">)]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Pseudo</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                            <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pseudos</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No pseudopotentials parsed from folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">top</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating PseudoTable with </span><span class="si">%i</span><span class="s1"> pseudopotentials&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudos</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">exts</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;psp8&quot;</span><span class="p">,)</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">find_exts</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">exts</span><span class="p">,</span> <span class="n">exclude_dirs</span><span class="o">=</span><span class="n">exclude_dirs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pseudo</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Error in </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span><span class="o">.</span><span class="n">sort_by_z</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            pseudos: List of pseudopotentials or filepaths</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Store pseudos in a default dictionary with z as key.</span>
        <span class="c1"># Note that we can have more than one pseudo for given z.</span>
        <span class="c1"># hence the values are lists of pseudos.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
            <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[</span><span class="n">pseudos</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_string</span><span class="p">(</span><span class="n">pseudos</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">pseudos</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pseudo</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">Pseudo</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">Pseudo</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">pseudo</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">Z</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlist</span><span class="p">:</span>
            <span class="n">pseudo_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span><span class="p">[</span><span class="n">z</span><span class="p">]</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudo_list</span><span class="p">]</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">symb</span> <span class="o">!=</span> <span class="n">symbol</span> <span class="k">for</span> <span class="n">symb</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All symbols must be equal while they are: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">pseudo_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve pseudos for the atomic number z. Accepts both int and slice objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">Z</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
            <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">znum</span> <span class="ow">in</span> <span class="n">iterator_from_slice</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
                <span class="n">pseudos</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span><span class="p">[</span><span class="n">znum</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span><span class="p">[</span><span class="n">Z</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the elements in Z order.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zlist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span><span class="p">[</span><span class="n">z</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">pseudo</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> at </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">app</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">, len=</span><span class="si">%d</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pseudo</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allnc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all pseudos are norm-conserving.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isnc</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">allpaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all pseudos are PAW.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">ispaw</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ordered list with the atomic numbers available in the table.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pseudos_with_z</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

<div class="viewcode-block" id="PseudoTable.as_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="mi">1</span>
            <span class="c1"># Handle multiple-pseudos with the same name!</span>
            <span class="k">while</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()})</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;@module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;@class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="n">d</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="PseudoTable.from_dict"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span></div>

<div class="viewcode-block" id="PseudoTable.is_complete"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.is_complete">[docs]</a>    <span class="k">def</span> <span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">118</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if table is complete i.e. all elements with Z &lt; zmax have at least on pseudopotential</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">zmax</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">[</span><span class="n">z</span><span class="p">]:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span></div>

<div class="viewcode-block" id="PseudoTable.all_combinations_for_elements"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.all_combinations_for_elements">[docs]</a>    <span class="k">def</span> <span class="nf">all_combinations_for_elements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element_symbols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list with all the the possible combination of pseudos</span>
<span class="sd">        for the given list of element_symbols.</span>
<span class="sd">        Each item is a list of pseudopotential objects.</span>

<span class="sd">        Example::</span>

<span class="sd">            table.all_combinations_for_elements([&quot;Li&quot;, &quot;F&quot;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">element_symbols</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_symbols</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">ret_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">all</span><span class="p">)</span></div>

<div class="viewcode-block" id="PseudoTable.pseudo_with_symbol"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.pseudo_with_symbol">[docs]</a>    <span class="k">def</span> <span class="nf">pseudo_with_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">allow_multi</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the pseudo with the given chemical symbol.</span>

<span class="sd">        Args:</span>
<span class="sd">            symbols: String with the chemical symbol of the element</span>
<span class="sd">            allow_multi: By default, the method raises ValueError</span>
<span class="sd">                if multiple occurrences are found. Use allow_multi to prevent this.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError if symbol is not found or multiple occurences are present and not allow_multi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_symbols</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">ret_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pseudos</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_multi</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> occurrences of symbol </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pseudos</span><span class="p">),</span> <span class="n">symbol</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_multi</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pseudos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pseudos</span></div>

<div class="viewcode-block" id="PseudoTable.pseudos_with_symbols"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.pseudos_with_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">pseudos_with_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the pseudos with the given chemical symbols.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError if one of the symbols is not found or multiple occurences are present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_symbols</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">ret_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">found_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pseudos</span><span class="p">]</span>
        <span class="n">duplicated_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">found_symbols</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">duplicated_elements</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found multiple occurrences of symbol(s) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">duplicated_elements</span><span class="p">))</span>
        <span class="n">missing_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found_symbols</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">missing_symbols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing data for symbol(s) </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_symbols</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pseudos</span></div>

<div class="viewcode-block" id="PseudoTable.select_symbols"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.select_symbols">[docs]</a>    <span class="k">def</span> <span class="nf">select_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">ret_list</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a :class:`PseudoTable` with the pseudopotentials with the given list of chemical symbols.</span>

<span class="sd">        Args:</span>
<span class="sd">            symbols: str or list of symbols</span>
<span class="sd">                Prepend the symbol string with &quot;-&quot;, to exclude pseudos.</span>
<span class="sd">            ret_list: if True a list of pseudos is returned instead of a :class:`PseudoTable`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;When excluding symbols, all strings must start with `-`&quot;</span><span class="p">)</span>
            <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">]</span>
            <span class="c1">#print(symbols)</span>

        <span class="n">symbols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span> <span class="k">continue</span>

            <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ret_list</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pseudos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span></div>

<div class="viewcode-block" id="PseudoTable.get_pseudos_for_structure"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.get_pseudos_for_structure">[docs]</a>    <span class="k">def</span> <span class="nf">get_pseudos_for_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the list of :class:`Pseudo` objects to be used for this :class:`Structure`.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: pymatgen :class:`Structure`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            `ValueError` if one of the chemical symbols is not found or</span>
<span class="sd">            multiple occurences are present in the table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">symbol_set</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos_with_symbols</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span></div>

    <span class="c1">#def list_properties(self, *props, **kw):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    Print a list of elements with the given set of properties.</span>

    <span class="c1">#    Args:</span>
    <span class="c1">#        *prop1*, *prop2*, ... : string</span>
    <span class="c1">#            Name of the properties to print</span>
    <span class="c1">#        *format*: string</span>
    <span class="c1">#            Template for displaying the element properties, with one</span>
    <span class="c1">#            % for each property.</span>

    <span class="c1">#    For example, print a table of mass and density.</span>

    <span class="c1">#    from periodictable import elements</span>
    <span class="c1">#    elements.list_properties(&#39;symbol&#39;,&#39;mass&#39;,&#39;density&#39;, format=&quot;%-2s: %6.2f u %5.2f g/cm^3&quot;)</span>
    <span class="c1">#    H :   1.01 u   0.07 g/cm^3</span>
    <span class="c1">#    He:   4.00 u   0.12 g/cm^3</span>
    <span class="c1">#    Li:   6.94 u   0.53 g/cm^3</span>
    <span class="c1">#    ...</span>
    <span class="c1">#    Bk: 247.00 u  14.00 g/cm^3</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    format = kw.pop(&#39;format&#39;, None)</span>
    <span class="c1">#    assert len(kw) == 0</span>

    <span class="c1">#    for pseudo in self:</span>
    <span class="c1">#        try:</span>
    <span class="c1">#            values = tuple(getattr(pseudo, p) for p in props)</span>
    <span class="c1">#        except AttributeError:</span>
    <span class="c1">#            # Skip elements which don&#39;t define all the attributes</span>
    <span class="c1">#            continue</span>

    <span class="c1">#        # Skip elements with a value of None</span>
    <span class="c1">#        if any(v is None for v in values):</span>
    <span class="c1">#            continue</span>

    <span class="c1">#        if format is None:</span>
    <span class="c1">#            print(&quot; &quot;.join(str(p) for p in values))</span>
    <span class="c1">#        else:</span>
    <span class="c1">#            try:</span>
    <span class="c1">#                print(format % values)</span>
    <span class="c1">#            except:</span>
    <span class="c1">#                print(&quot;format&quot;,format,&quot;args&quot;,values)</span>
    <span class="c1">#                raise</span>

    <span class="c1">#def print_table(self, stream=sys.stdout, filter_function=None):</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    A pretty ASCII printer for the periodic table, based on some filter_function.</span>
    <span class="c1">#    Args:</span>
    <span class="c1">#        filter_function:</span>
    <span class="c1">#            A filtering function that take a Pseudo as input and returns a boolean.</span>
    <span class="c1">#            For example, setting filter_function = lambda el: el.Z_val &gt; 2 will print</span>
    <span class="c1">#            a periodic table containing only pseudos with Z_val &gt; 2.</span>
    <span class="c1">#    &quot;&quot;&quot;</span>
    <span class="c1">#    for row in range(1, 10):</span>
    <span class="c1">#        rowstr = []</span>
    <span class="c1">#        for group in range(1, 19):</span>
    <span class="c1">#            el = Element.from_row_and_group(row, group)</span>
    <span class="c1">#            if el and ((not filter_function) or filter_function(el)):</span>
    <span class="c1">#                rowstr.append(&quot;{:3s}&quot;.format(el.symbol))</span>
    <span class="c1">#            else:</span>
    <span class="c1">#                rowstr.append(&quot;   &quot;)</span>
    <span class="c1">#        print(&quot; &quot;.join(rowstr))</span>

<div class="viewcode-block" id="PseudoTable.sorted"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.sorted">[docs]</a>    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sort the table according to the value of attribute attrname.</span>

<span class="sd">        Return:</span>
<span class="sd">            New class:`PseudoTable` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pseudo</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

        <span class="c1"># Sort attrs, and build new table with sorted pseudos.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)])</span></div>

<div class="viewcode-block" id="PseudoTable.sort_by_z"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.sort_by_z">[docs]</a>    <span class="k">def</span> <span class="nf">sort_by_z</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new :class:`PseudoTable` with pseudos sorted by Z&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">Z</span><span class="p">))</span></div>

<div class="viewcode-block" id="PseudoTable.select"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Select only those pseudopotentials for which condition is True.</span>
<span class="sd">        Return new class:`PseudoTable` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            condition:</span>
<span class="sd">                Function that accepts a :class:`Pseudo` object and returns True or False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">p</span><span class="p">)])</span></div>

<div class="viewcode-block" id="PseudoTable.with_dojo_report"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.with_dojo_report">[docs]</a>    <span class="k">def</span> <span class="nf">with_dojo_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select pseudos containing the DOJO_REPORT section. Return new class:`PseudoTable` object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">condition</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">has_dojo_report</span><span class="p">)</span></div>

<div class="viewcode-block" id="PseudoTable.get_dojo_dataframe"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.get_dojo_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">get_dojo_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Buid a pandas :class:`DataFrame` with the most important parameters extracted from the</span>
<span class="sd">        `DOJO_REPORT` section of each pseudo in the table.</span>

<span class="sd">        Returns:</span>
<span class="sd">            frame, errors</span>

<span class="sd">            where frame is the pandas :class:`DataFrame` and errors is a list of errors</span>
<span class="sd">            encountered while trying to read the `DOJO_REPORT` from the pseudopotential file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span>

        <span class="n">trial2keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;deltafactor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;dfact_meV&quot;</span><span class="p">,</span> <span class="s2">&quot;dfactprime_meV&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;v0&quot;</span><span class="p">,</span> <span class="s2">&quot;b0_GPa&quot;</span><span class="p">,</span> <span class="s2">&quot;b1&quot;</span><span class="p">],</span>
            <span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a0_rel_err&quot;</span><span class="p">],</span>
            <span class="s2">&quot;gbrv_fcc&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a0_rel_err&quot;</span><span class="p">],</span>
            <span class="s2">&quot;phonon&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
            <span class="c1">#&quot;phwoa&quot;: &quot;all&quot;</span>
        <span class="p">}</span>

        <span class="n">rows</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">dojo_report</span>
            <span class="c1">#assert &quot;version&quot;  in report</span>
            <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;ignoring old report in &quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">Z</span><span class="p">}</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

            <span class="c1">#read hints</span>
            <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_ecut_hint&quot;</span><span class="p">:</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;hints&#39;</span><span class="p">][</span><span class="n">acc</span><span class="p">][</span><span class="s1">&#39;ecut&#39;</span><span class="p">]})</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_ecut_hint&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span> <span class="p">})</span>

            <span class="c1"># FIXME</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ecut_acc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">low</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">normal</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)],</span>
                    <span class="n">high</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">ecut_acc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">low</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">normal</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">high</span><span class="o">=</span><span class="n">report</span><span class="o">.</span><span class="n">ecuts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_ecut&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecut_acc</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">trial</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">trial2keys</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="c1"># if the current trial has an entry for this ecut notting changes, else we take the ecut closes</span>
                    <span class="n">ecut_acc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">low</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">normal</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">/</span><span class="mi">2</span><span class="p">)],</span>
                        <span class="n">high</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">:</span>
                        <span class="n">ecut</span> <span class="o">=</span> <span class="n">ecut_acc</span><span class="p">[</span><span class="n">acc</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">keys</span> <span class="ow">is</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                            <span class="n">ecuts</span> <span class="o">=</span> <span class="n">data</span>
                            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">trial</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">ecut</span><span class="p">]})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">trial</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;gbrv&quot;</span><span class="p">):</span>
                                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">trial</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ecut</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">ecut</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">})</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> raised </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>

            <span class="c1">#print(d)</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c1"># Build sub-class of pandas.DataFrame</span>
        <span class="k">return</span> <span class="n">DojoDataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">names</span><span class="p">),</span> <span class="n">errors</span></div>

<div class="viewcode-block" id="PseudoTable.select_rows"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.select_rows">[docs]</a>    <span class="k">def</span> <span class="nf">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return new class:`PseudoTable` object with pseudos in the given rows of the periodic table.</span>
<span class="sd">        rows can be either a int or a list of integers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span></div>

<div class="viewcode-block" id="PseudoTable.select_family"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.select_family">[docs]</a>    <span class="k">def</span> <span class="nf">select_family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">family</span><span class="p">):</span>
        <span class="c1"># e.g element.is_alkaline</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">([</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;is_&quot;</span> <span class="o">+</span> <span class="n">family</span><span class="p">)])</span></div>

<div class="viewcode-block" id="PseudoTable.dojo_compare"><a class="viewcode-back" href="../../../../pymatgen.io.abinit.html#pymatgen.io.abinit.pseudos.PseudoTable.dojo_compare">[docs]</a>    <span class="k">def</span> <span class="nf">dojo_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare ecut convergence and Deltafactor, GBRV results&quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">show</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;show&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">what</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dojo_report</span><span class="o">.</span><span class="n">has_trial</span><span class="p">(</span><span class="s2">&quot;deltafactor&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;ecut&quot;</span><span class="p">)):</span>

            <span class="n">fig_etotal</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=len(self), ncols=1, sharex=True, squeeze=True)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_etotal</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">pseudo</span><span class="o">.</span><span class="n">dojo_report</span><span class="o">.</span><span class="n">plot_etotal_vs_ecut</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">pseudo</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dojo_report</span><span class="o">.</span><span class="n">has_trial</span><span class="p">(</span><span class="s2">&quot;deltafactor&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="s2">&quot;deltafactor&quot;</span><span class="p">)):</span>

            <span class="n">fig_deltafactor</span><span class="p">,</span> <span class="n">ax_grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=5, ncols=len(self), sharex=True, sharey=&quot;row&quot;, squeeze=False))</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_deltafactor</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ax_list</span><span class="p">,</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_grid</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">pseudo</span><span class="o">.</span><span class="n">dojo_report</span><span class="o">.</span><span class="n">plot_deltafactor_convergence</span><span class="p">(</span><span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="n">fig_deltafactor</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot; vs &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># Compare GBRV results</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">dojo_report</span><span class="o">.</span><span class="n">has_trial</span><span class="p">(</span><span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;gbrv&quot;</span><span class="p">)):</span>

            <span class="n">fig_gbrv</span><span class="p">,</span> <span class="n">ax_grid</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig_gbrv</span><span class="p">)</span>
            <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, ncols=len(self), sharex=True, sharey=&quot;row&quot;, squeeze=False))</span>

            <span class="k">for</span> <span class="n">ax_list</span><span class="p">,</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_grid</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
                <span class="n">pseudo</span><span class="o">.</span><span class="n">dojo_report</span><span class="o">.</span><span class="n">plot_gbrv_convergence</span><span class="p">(</span><span class="n">ax_list</span><span class="o">=</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="n">fig_gbrv</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot; vs &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">show</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">figs</span></div>

    <span class="nd">@classmethod</span>
    <span class="nd">@deprecated</span><span class="p">(</span><span class="n">replacement</span><span class="o">=</span><span class="n">from_dir</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">from_directory</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">Pseudo</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                        <span class="n">pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pseudos</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No pseudopotentials parsed from folder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating PseudoTable with </span><span class="si">%i</span><span class="s1"> pseudopotentials&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudos</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">pseudos</span><span class="p">)</span></div>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">DataFrame</span> <span class="o">=</span> <span class="nb">object</span>


<span class="k">class</span> <span class="nc">DojoDataFrame</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extends pandas DataFrame adding helper functions.&quot;&quot;&quot;</span>
    <span class="n">ALL_ACCURACIES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>

    <span class="n">ALL_TRIALS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;ecut&quot;</span><span class="p">,</span>
        <span class="s2">&quot;deltafactor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_fcc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phonon&quot;</span><span class="p">,</span>
        <span class="c1">#&quot;phwoa&quot;</span>
    <span class="p">)</span>

    <span class="n">_TRIALS2KEY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ecut&quot;</span><span class="p">:</span> <span class="s2">&quot;ecut&quot;</span><span class="p">,</span>
        <span class="s2">&quot;deltafactor&quot;</span><span class="p">:</span> <span class="s2">&quot;dfact_meV&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">:</span> <span class="s2">&quot;gbrv_bcc_a0_rel_err&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_fcc&quot;</span><span class="p">:</span> <span class="s2">&quot;gbrv_fcc_a0_rel_err&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phonon&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="c1">#&quot;phwoa&quot;: &quot;all&quot;</span>
    <span class="p">}</span>

    <span class="n">_TRIALS2YLABEL</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ecut&quot;</span><span class="p">:</span> <span class="s2">&quot;Ecut [Ha]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;deltafactor&quot;</span><span class="p">:</span> <span class="s2">&quot;$\Delta$-factor [meV]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">:</span> <span class="s2">&quot;BCC $\Delta a_0$ (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_fcc&quot;</span><span class="p">:</span> <span class="s2">&quot;FCC $\Delta a_0$ (%)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phonon&quot;</span><span class="p">:</span> <span class="s2">&quot;Phonons with ASR&quot;</span><span class="p">,</span>
        <span class="c1">#&quot;phwoa&quot;: &quot;Phonons without ASR&quot;</span>
    <span class="p">}</span>

    <span class="n">ACC2PLTOPTS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">low</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">),</span>
        <span class="n">normal</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">),</span>
        <span class="n">high</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ACC2PLTOPTS</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">v</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tabulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">accuracies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_ACCURACIES</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_dfact_meV&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_ecut&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_gbrv_fcc_a0_rel_err&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
            <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_gbrv_bcc_a0_rel_err&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>

        <span class="c1">#return self[columns].to_html()</span>
        <span class="n">tablefmt</span> <span class="o">=</span> <span class="s2">&quot;grid&quot;</span>
        <span class="n">floatfmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tabulate</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">columns</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="s2">&quot;keys&quot;</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="n">tablefmt</span><span class="p">,</span> <span class="n">floatfmt</span><span class="o">=</span><span class="n">floatfmt</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_accuracy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accuracy</span><span class="p">):</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">accuracy</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">columns</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_trials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">accuracies</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_ACCURACIES</span> <span class="k">if</span> <span class="n">accuracies</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_dfact_meV&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_ecut&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_gbrv_fcc_a0_rel_err&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
        <span class="n">columns</span> <span class="o">+=</span> <span class="p">[</span><span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_gbrv_bcc_a0_rel_err&quot;</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">columns</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">select_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="p">]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">select_family</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">family</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">Element</span><span class="o">.</span><span class="n">from_Z</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">Z</span><span class="p">)</span>
            <span class="c1"># e.g element.is_alkaline</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s2">&quot;is_&quot;</span> <span class="o">+</span> <span class="n">family</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="s2">&quot;dfact_meV&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALL_ACCURACIES</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=len(self.ALL_ACCURACIES), ncols=1, sharex=True, sharey=False, squeeze=True)</span>

        <span class="k">for</span> <span class="n">acc</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALL_ACCURACIES</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">what</span>
            <span class="c1">#print(col)</span>
            <span class="c1">#self[col].hist(ax=ax, bins=bins, label=col)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_trials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trials</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">accuracies</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span> <span class="k">if</span> <span class="n">trials</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
        <span class="n">accuracies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_ACCURACIES</span> <span class="k">if</span> <span class="n">accuracies</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">else</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">accuracies</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">trials</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=len(trials), ncols=1, sharex=True, sharey=False, squeeze=True)</span>

        <span class="c1"># See also http://matplotlib.org/examples/pylab_examples/barchart_demo.html</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="n">ax_list</span><span class="p">)):</span>
            <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TRIALS2KEY</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_TRIALS2YLABEL</span><span class="p">[</span><span class="n">trial</span><span class="p">])</span>
            <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accuracies</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">acc</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">what</span>
                <span class="n">legend</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxval</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="n">legend</span><span class="p">,</span> <span class="n">use_index</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">acc</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">ACC2PLTOPTS</span><span class="p">[</span><span class="n">acc</span><span class="p">])</span>
                <span class="c1">#data.plot(ax=ax, kind=&quot;bar&quot;)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1">#fancybox=True)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="c1">#ax.set_xticklabels([root for root, ext in map(os.path.splitext, data.index)])</span>

            <span class="c1"># Set ylimits</span>
            <span class="c1">#stepsize = None</span>
            <span class="c1">#if &quot;gbrv&quot; in trial:</span>
            <span class="c1">#    ax.hlines(0.0, 0, len(data.index))</span>
            <span class="c1">#    #start, end = -0.6, +0.6</span>
            <span class="c1">#    start, end = max(-0.6, minval), min(+0.6, maxval)</span>
            <span class="c1">#    if end - start &lt; 0.05: end = start + 0.1</span>
            <span class="c1">#    ax.set_ylim(start, end)</span>
            <span class="c1">#    ax.yaxis.set_ticks(np.arange(start, end, 0.05))</span>

            <span class="k">if</span> <span class="n">trial</span> <span class="o">==</span> <span class="s2">&quot;deltafactor&quot;</span><span class="p">:</span>
                <span class="c1">#start, end = 0.0, 15</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span>  <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="c1">#ax.yaxis.set_ticks(np.arange(start, end, 0.1))</span>

            <span class="c1">#if stepsize is not None:</span>
            <span class="c1">#    start, end = ax.get_ylim()</span>
            <span class="c1">#    ax.yaxis.set_ticks(np.arange(start, end, stepsize))</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>


<span class="k">class</span> <span class="nc">DojoReportError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised by DoJoReport.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">DojoReport</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dict-like object with the dojo report.&quot;&quot;&quot;</span>

    <span class="n">_TRIALS2KEY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;deltafactor&quot;</span><span class="p">:</span> <span class="s2">&quot;dfact_meV&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">:</span> <span class="s2">&quot;a0_rel_err&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_fcc&quot;</span><span class="p">:</span> <span class="s2">&quot;a0_rel_err&quot;</span><span class="p">,</span>
        <span class="c1">#&quot;phwoa&quot;: &quot;all&quot;,</span>
        <span class="s2">&quot;phonon&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span>
    <span class="p">}</span>

    <span class="n">ALL_ACCURACIES</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">)</span>

    <span class="c1"># List of dojo_trials</span>
    <span class="c1"># Remember to update the list if you add a new test to the DOJO_REPORT</span>
    <span class="n">ALL_TRIALS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;deltafactor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_bcc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;gbrv_fcc&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phonon&quot;</span><span class="p">,</span>
        <span class="c1">#&quot;phwoa&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Tolerances on the deltafactor prime (in eV) used for the hints.</span>
    <span class="c1">#ATOLS = (1.0, 0.2, 0.04)</span>
    <span class="n">ATOLS</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>

    <span class="n">Error</span> <span class="o">=</span> <span class="n">DojoReportError</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the DojoReport from file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{}</span>

            <span class="n">stop</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&lt;/DOJO_REPORT&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#print(&quot;start, stop&quot; ,start, stop)</span>
            <span class="c1">#print(&quot;&quot;.join(lines[start+1:stop]))</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">stop</span><span class="p">]))</span>
            <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hints</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">ppgen_ecut</span><span class="p">,</span> <span class="n">symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the DojoReport from an initial value of ecut in Hartree.&quot;&quot;&quot;</span>
        <span class="n">dense_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ppgen_ecut</span><span class="p">,</span> <span class="n">ppgen_ecut</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dense_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ppgen_ecut</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ppgen_ecut</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">coarse_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ppgen_ecut</span> <span class="o">+</span> <span class="mi">15</span><span class="p">,</span> <span class="n">ppgen_ecut</span> <span class="o">+</span> <span class="mi">35</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">ecut_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dense_left</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">dense_right</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">coarse_high</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">ecut_list</span><span class="o">=</span><span class="n">ecut_list</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">)</span> <span class="c1">#, **{k: {}: for k in self.ALL_TRIALS})</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DojoReport</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span><span class="p">:</span>
                <span class="c1"># Convert ecut to float and build an OrderedDict (results are indexed by ecut in ascending order)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">ecuts_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="nb">ord</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ecuts_keys</span><span class="p">])</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ord</span>

        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s1">&#39;Error while initializing the dojo report&#39;</span><span class="p">)</span>

    <span class="c1">#def __str__(self):</span>
    <span class="c1">#    stream = six.moves.StringIO()</span>
    <span class="c1">#    pprint.pprint(self, stream=stream, indent=2, width=80)</span>
    <span class="c1">#    return stream.getvalue()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Chemical symbol.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;symbol&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Element object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Element</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if hints on cutoff energy are present.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;hints&quot;</span> <span class="ow">in</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ecuts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Numpy array with the list of ecuts that should be present in the dojo_trial sub-dicts&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ecuts&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trials</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set of strings with the trials present in the report.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_trial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dojo_trial</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the dojo_report contains dojo_trial with the given ecut.</span>
<span class="sd">        If ecut is not, we test if dojo_trial is present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dojo_trial</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;dojo_trial `</span><span class="si">%s</span><span class="s2">` is not a registered DOJO TRIAL&quot;</span> <span class="o">%</span> <span class="n">dojo_trial</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ecut</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dojo_trial</span> <span class="ow">in</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#key = self._ecut2key(ecut)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">ecut</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">dojo_trial</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">add_ecuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ecuts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a list of new ecut values.&quot;&quot;&quot;</span>
        <span class="c1"># Be careful with the format here! it should be %.1f</span>
        <span class="c1"># Select the list of ecuts reported in the DOJO section.</span>
        <span class="n">prev_ecuts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ecuts&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prev_ecuts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prev_ecuts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">prev_ecuts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Ecut list is not ordered:</span><span class="se">\n</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">prev_ecuts</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">monty.bisect</span> <span class="kn">import</span> <span class="n">find_le</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">new_ecuts</span><span class="p">:</span>
            <span class="c1"># Find rightmost value less than or equal to x.</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">prev_ecuts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">prev_ecuts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_ecuts</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">find_le</span><span class="p">(</span><span class="n">prev_ecuts</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">prev_ecuts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">e</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">prev_ecuts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hints</span><span class="p">):</span>
        <span class="n">hints_dict</span> <span class="o">=</span> <span class="p">{</span>
           <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ecut&#39;</span><span class="p">:</span> <span class="n">hints</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span>
           <span class="s2">&quot;normal&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ecut&#39;</span><span class="p">:</span> <span class="n">hints</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
           <span class="s2">&quot;high&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ecut&#39;</span><span class="p">:</span> <span class="n">hints</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>
                     <span class="p">}</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;hints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hints_dict</span>

    <span class="c1">#def validate(self, hints):</span>
    <span class="c1">#    Add md5 hash value</span>
    <span class="c1">#    self[&quot;validated&quot;] = True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_ecut2key</span><span class="p">(</span><span class="n">ecut</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert ecut to a valid key. ecut can be either a string or a float.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_string</span><span class="p">(</span><span class="n">ecut</span><span class="p">):</span>
            <span class="c1"># Validate string</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">ecut</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecut</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;string </span><span class="si">%s</span><span class="s2"> must have one digit&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ecut</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Assume float</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ecut</span>

    <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dojo_trial</span><span class="p">,</span> <span class="n">ecut</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add an entry computed with the given ecut to the sub-dictionary associated to dojo_trial.</span>

<span class="sd">        Args:</span>
<span class="sd">            dojo_trial:</span>
<span class="sd">            ecut:</span>
<span class="sd">            d:</span>
<span class="sd">            overwrite:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dojo_trial</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not a registered trial&quot;</span><span class="p">)</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dojo_trial</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ecut2key</span><span class="p">(</span><span class="n">ecut</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">section</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Cannot overwrite key </span><span class="si">%s</span><span class="s2"> in dojo_trial </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">dojo_trial</span><span class="p">))</span>

        <span class="n">section</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">find_missing_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        check the DojoReport.</span>
<span class="sd">        This function tests if each trial contains an ecut entry.</span>
<span class="sd">        Return a dictionary {trial_name: [list_of_missing_ecuts]}</span>
<span class="sd">        mapping the name of the Dojo trials to the list of ecut values that are missing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># Gbrv results do not contain noble gases so ignore the error</span>
                <span class="k">if</span> <span class="s2">&quot;gbrv&quot;</span> <span class="ow">in</span> <span class="n">trial</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">is_noble_gas</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="k">continue</span>
                <span class="n">d</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecuts</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">computed_ecuts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecuts</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">computed_ecuts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trial</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">computed_ecuts</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecuts</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">print_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">monty.pprint</span> <span class="kn">import</span> <span class="n">pprint_table</span>
        <span class="n">pprint_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">(),</span> <span class="n">out</span><span class="o">=</span><span class="n">stream</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_etotal_vs_ecut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">inv_ecut</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the convergence of the total energy as function of the energy cutoff ecut</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib Axes, if ax is None a new figure is created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract the total energy of the AE relaxed structure (4).</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">ecut</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;etotals&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span> <span class="k">for</span> <span class="n">ecut</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;deltafactor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="c1"># Ecut mesh in Ha</span>
        <span class="n">ecuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">ecut_min</span><span class="p">,</span> <span class="n">ecut_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ecuts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ecuts</span><span class="p">)</span>

        <span class="c1"># Energies per atom in meV and difference wrt &#39;converged&#39; value</span>
        <span class="n">num_sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;num_sites&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;deltafactor&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">etotals_mev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ecuts</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="o">/</span> <span class="n">num_sites</span>
        <span class="n">ediffs</span> <span class="o">=</span> <span class="n">etotals_mev</span> <span class="o">-</span> <span class="n">etotals_mev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="c1">#ax.yaxis.set_view_interval(-5, 5)</span>

        <span class="n">lines</span><span class="p">,</span> <span class="n">legends</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">xs</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">ecuts</span> <span class="k">if</span> <span class="n">inv_ecut</span> <span class="k">else</span> <span class="n">ecuts</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">etotals_mev</span> <span class="k">if</span> <span class="n">inv_ecut</span> <span class="k">else</span> <span class="n">ediffs</span>

        <span class="n">line</span><span class="p">,</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span> <span class="c1">#, linewidth=3.0, markersize=15)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="p">[</span><span class="n">label</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">high_hint</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;ppgen_hints&quot;</span><span class="p">][</span><span class="s2">&quot;high&quot;</span><span class="p">][</span><span class="s2">&quot;ecut&quot;</span><span class="p">]</span>
        <span class="c1">#ax.vlines(high_hint, min(ediffs), max(ediffs))</span>
        <span class="c1">#ax.vlines(high_hint, 0.5, 1.5)</span>
        <span class="c1">#ax.scatter([high_hint], [1.0], s=20) #, c=&#39;b&#39;, marker=&#39;o&#39;, cmap=None, norm=None)</span>
        <span class="c1">#ax.arrow(high_hint, 1, 0, 0.2, head_width=0.05, head_length=0.1, fc=&#39;k&#39;, ec=&#39;k&#39;,head_starts_at_zero=False)</span>

        <span class="c1">#ax.hlines(5, ecut_min, ecut_max, label=&quot;5.0&quot;)</span>
        <span class="c1">#ax.hlines(1, ecut_min, ecut_max, label=&quot;1.0&quot;)</span>
        <span class="c1">#ax.hlines(0.5, ecut_min, ecut_max, label=&quot;0.2&quot;)</span>

        <span class="c1"># Set xticks and labels.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Ecut [Ha]&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Delta Etotal/natom [meV]&quot;</span><span class="p">)</span>
        <span class="c1">#ax.set_xlim(0, max(xs))</span>

        <span class="c1"># Use logscale if possible.</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">ediffs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xs</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_deltafactor_eos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the EOS computed with the deltafactor setup.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        ================  ==============================================================</span>
<span class="sd">        kwargs            Meaning</span>
<span class="sd">        ================  ==============================================================</span>
<span class="sd">        cmap              Color map. default `jet`</span>
<span class="sd">        ================  ==============================================================</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">trial</span> <span class="o">=</span> <span class="s2">&quot;deltafactor&quot;</span>
        <span class="n">ecuts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">num_ecuts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecuts</span><span class="p">)</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ecuts</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="n">ecut</span><span class="p">]</span>
            <span class="n">num_sites</span><span class="p">,</span> <span class="n">volumes</span><span class="p">,</span> <span class="n">etotals</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;num_sites&quot;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;volumes&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;etotals&quot;</span><span class="p">])</span>

            <span class="c1"># Use same fit as the one employed for the deltafactor.</span>
            <span class="n">eos_fit</span> <span class="o">=</span> <span class="n">EOS</span><span class="o">.</span><span class="n">DeltaFactor</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">volumes</span><span class="o">/</span><span class="n">num_sites</span><span class="p">,</span> <span class="n">etotals</span><span class="o">/</span><span class="n">num_sites</span><span class="p">)</span>

            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;ecut </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ecut</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;ecut </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ecut</span>
            <span class="n">eos_fit</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">num_ecuts</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">get_ecut_dfactprime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;deltafactor&quot;</span><span class="p">]</span>
        <span class="n">ecuts</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s2">&quot;dfactprime_meV&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ecuts</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ecuts</span><span class="p">),</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">compute_hints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ecuts</span><span class="p">,</span> <span class="n">dfacts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ecut_dfactprime</span><span class="p">()</span>
        <span class="n">abs_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">dfacts</span> <span class="o">-</span> <span class="n">dfacts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1">#print(list(zip(ecuts, dfacts)))</span>
        <span class="c1">#print(abs_diffs)</span>

        <span class="n">hints</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ecut</span><span class="p">,</span> <span class="n">adiff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ecuts</span><span class="p">,</span> <span class="n">abs_diffs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">adiff</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATOLS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">hints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">hints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ecut</span>
                <span class="k">if</span> <span class="n">adiff</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATOLS</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">hints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">hints</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the dojo report for inconsistencies.</span>
<span class="sd">        Return a string with the errors found in the DOJO_REPORT.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">append</span>

        <span class="k">if</span> <span class="s2">&quot;version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;version is missing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;ppgen_hints&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;version is missing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;md5&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;md5 checksum is missing!&quot;</span><span class="p">)</span>

        <span class="c1"># Check if we have computed each trial for the full set of ecuts in global_ecuts</span>
        <span class="n">global_ecuts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecuts</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALL_TRIALS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">global_ecuts</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_trial</span><span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">):</span>
                    <span class="n">missing</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ecut</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="s2">&quot;The following list of ecut energies is missing:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">trial</span><span class="p">,</span> <span class="n">ecuts</span> <span class="ow">in</span> <span class="n">missing</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">app</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trial</span><span class="p">,</span> <span class="n">ecuts</span><span class="p">))</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">)</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_deltafactor_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;WIEN2k&quot;</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot the convergence of the deltafactor parameters wrt ecut.</span>

<span class="sd">        Args:</span>
<span class="sd">            code: Reference code</span>
<span class="sd">            ax_list: List of matplotlib Axes, if ax_list is None a new figure is created</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">all</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dfact_meV&quot;</span><span class="p">,</span> <span class="s2">&quot;dfactprime_meV&quot;</span><span class="p">,</span> <span class="s2">&quot;v0&quot;</span><span class="p">,</span> <span class="s2">&quot;b0_GPa&quot;</span><span class="p">,</span> <span class="s2">&quot;b1&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">what</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="nb">all</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">what</span> <span class="o">=</span> <span class="n">list_strings</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="c1"># Exclude keys</span>
                <span class="c1">#print([type(w) for w in what])</span>
                <span class="n">what</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">what</span><span class="p">]</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">all</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">what</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="n">what</span>

        <span class="c1"># get reference entry</span>
        <span class="kn">from</span> <span class="nn">pseudo_dojo.refdata.deltafactor</span> <span class="kn">import</span> <span class="n">df_database</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">df_database</span><span class="p">()</span><span class="o">.</span><span class="n">get_entry</span><span class="p">(</span><span class="n">symbol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;deltafactor&quot;</span><span class="p">]</span>
        <span class="n">ecuts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="k">if</span> <span class="n">ax_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=len(keys), ncols=1, sharex=True, squeeze=False)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;len(keys)=</span><span class="si">%s</span><span class="s2"> != len(ax_list)=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">keys</span><span class="p">)):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ecut</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">ecuts</span><span class="p">])</span>
            <span class="c1">#try:</span>
            <span class="n">refval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="c1">#except AttributeError:</span>
            <span class="c1">#    refval = 0.0</span>

            <span class="c1"># Plot difference pseudo - ref.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecuts</span><span class="p">,</span> <span class="n">values</span> <span class="o">-</span> <span class="n">refval</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\Delta$&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Ecut [Ha]&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;dfactprime_meV&quot;</span><span class="p">:</span>
                <span class="c1"># Add horizontal lines (used to find hints for ecut).</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ecuts</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">ecuts</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pad</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ATOLS</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;violet&quot;</span><span class="p">)):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">last</span> <span class="o">+</span> <span class="n">pad</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">last</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

                <span class="c1"># Set proper limits so that we focus on the relevant region.</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">last</span> <span class="o">-</span> <span class="mf">1.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ATOLS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last</span> <span class="o">+</span> <span class="mf">1.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ATOLS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_gbrv_eos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct_type</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses Matplotlib to plot the EOS computed with the GBRV setup</span>

<span class="sd">        Args:</span>
<span class="sd">            ax: matplotlib :class:`Axes` or None if a new figure should be created.</span>

<span class="sd">        ================  ==============================================================</span>
<span class="sd">        kwargs            Meaning</span>
<span class="sd">        ================  ==============================================================</span>
<span class="sd">        cmap              Color map. default `jet`</span>
<span class="sd">        ================  ==============================================================</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure or None if the GBRV test is not present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">plt</span> <span class="o">=</span> <span class="n">get_ax_fig_plt</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">trial</span> <span class="o">=</span> <span class="s2">&quot;gbrv_&quot;</span> <span class="o">+</span> <span class="n">struct_type</span>
        <span class="c1"># Handle missing entries: noble gases, Hg ...</span>
        <span class="k">if</span> <span class="n">trial</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">ecuts</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">num_ecuts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ecuts</span><span class="p">)</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cmap&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;jet&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ecuts</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="n">ecut</span><span class="p">]</span>
            <span class="n">volumes</span><span class="p">,</span> <span class="n">etotals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;volumes&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;etotals&quot;</span><span class="p">])</span>

            <span class="n">eos_fit</span> <span class="o">=</span> <span class="n">EOS</span><span class="o">.</span><span class="n">Quadratic</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">volumes</span><span class="p">,</span> <span class="n">etotals</span><span class="p">)</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;ecut </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ecut</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;ecut </span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ecut</span>
            <span class="n">eos_fit</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">num_ecuts</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_gbrv_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses Matplotlib to plot the convergence of the GBRV parameters wrt ecut.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax_list: List of matplotlib Axes, if ax_list is None a new figure is created</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">stypes</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;fcc&quot;</span><span class="p">,</span> <span class="s2">&quot;bcc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ax_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax_list</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stypes</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">ax_list</span> <span class="o">=</span> <span class="n">ax_list</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=len(stypes), ncols=1, sharex=True, squeeze=False)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stypes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;len(stypes)=</span><span class="si">%s</span><span class="s2"> != len(ax_list)=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>  <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stypes</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">stype</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ax_list</span><span class="p">,</span> <span class="n">stypes</span><span class="p">)):</span>
            <span class="n">trial</span> <span class="o">=</span> <span class="s2">&quot;gbrv_&quot;</span> <span class="o">+</span> <span class="n">stype</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span>
            <span class="n">ecuts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ecut</span><span class="p">][</span><span class="s2">&quot;a0_rel_err&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">ecuts</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\Delta$&quot;</span> <span class="o">+</span> <span class="n">trial</span> <span class="o">+</span> <span class="s2">&quot;a0_rel_err&quot;</span><span class="p">)</span>

            <span class="c1"># Plot difference pseudo - ref.</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ecuts</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="s2">&quot;bo-&quot;</span><span class="p">)</span>
            <span class="c1">#ax.hlines(y=0.0, xmin=min(ecuts), xmax=max(ecuts), color=&quot;red&quot;)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Ecut [Ha]&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="nd">@add_fig_kwargs</span>
    <span class="k">def</span> <span class="nf">plot_phonon_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the convergence of the phonon modes wrt ecut.</span>

<span class="sd">        Args:</span>
<span class="sd">            ax_list: List of matplotlib Axes, if ax_list is None a new figure is created</span>

<span class="sd">        Returns:</span>
<span class="sd">            `matplotlib` figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;phonon&quot;</span><span class="p">]</span>
        <span class="n">ecuts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">l</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ecut</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">ecut</span><span class="p">))</span> <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">ecuts</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">max_ecut</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">s_ecuts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ecut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>

        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#ax_list, fig, plt = get_axarray_fig_plt(ax_list, nrows=len(keys), ncols=1, sharex=True, squeeze=False)</span>

        <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ecuts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
            <span class="n">values1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ecut</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">s_ecuts</span><span class="p">])</span>
            <span class="n">fmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">values1</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">fmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fmax</span><span class="p">,</span> <span class="n">values1</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_ecuts</span><span class="p">,</span> <span class="n">values1</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;phonon modes [meV] (asr==2)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Ecut [Ha]&quot;</span><span class="p">)</span>

            <span class="n">values2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">ecut</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">max_ecut</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">ecut</span> <span class="ow">in</span> <span class="n">s_ecuts</span><span class="p">])</span>

            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_ecuts</span><span class="p">,</span> <span class="n">values2</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;w - w(ecut_max) [meV]&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Ecut [Ha]&quot;</span><span class="p">)</span>

        <span class="c1"># Adjust limits.</span>
        <span class="n">fmin</span> <span class="o">-=</span> <span class="mi">10</span>
        <span class="n">fmax</span> <span class="o">+=</span> <span class="mi">10</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../index.html">pymatgen 3.6.1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2011, Pymatgen Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>