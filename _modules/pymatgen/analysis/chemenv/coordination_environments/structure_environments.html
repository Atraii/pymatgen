<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.analysis.chemenv.coordination_environments.structure_environments &#8212; pymatgen 4.3.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '4.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 4.3.0 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">pymatgen 4.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pymatgen.analysis.chemenv.coordination_environments.structure_environments</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="c1"># Copyright (c) Pymatgen Development Team.</span>
<span class="c1"># Distributed under the terms of the MIT License.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains objects that are used to describe the environments in a structure. The most detailed object</span>
<span class="sd">(StructureEnvironments) contains a very thorough analysis of the environments of a given atom but is difficult to</span>
<span class="sd">used as such. The LightStructureEnvironments object is a lighter version that is obtained by applying a &quot;strategy&quot;</span>
<span class="sd">on the StructureEnvironments object. Basically, the LightStructureEnvironments provides the coordination environment(s)</span>
<span class="sd">and possibly some fraction corresponding to these.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;David Waroquiers&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2012, The Materials Project&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="s2">&quot;Geoffroy Hautier&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;David Waroquiers&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;david.waroquiers@gmail.com&quot;</span>
<span class="n">__date__</span> <span class="o">=</span> <span class="s2">&quot;Feb 20, 2016&quot;</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.sites</span> <span class="k">import</span> <span class="n">PeriodicSite</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">MSONable</span><span class="p">,</span> <span class="n">MontyDecoder</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.periodic_table</span> <span class="k">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Specie</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">jsanitize</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.chemenv.coordination_environments.voronoi</span> <span class="k">import</span> <span class="n">DetailedVoronoiContainer</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.chemenv.utils.chemenv_errors</span> <span class="k">import</span> <span class="n">ChemenvError</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.chemenv.coordination_environments.coordination_geometries</span> <span class="k">import</span> <span class="n">AllCoordinationGeometries</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.chemenv.utils.defs_utils</span> <span class="k">import</span> <span class="n">AdditionalConditions</span>

<span class="n">allcg</span> <span class="o">=</span> <span class="n">AllCoordinationGeometries</span><span class="p">()</span>
<span class="n">symbol_cn_mapping</span> <span class="o">=</span> <span class="n">allcg</span><span class="o">.</span><span class="n">get_symbol_cn_mapping</span><span class="p">()</span>

<div class="viewcode-block" id="StructureEnvironments"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments">[docs]</a><span class="k">class</span> <span class="nc">StructureEnvironments</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class used to store the chemical environments of a given structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AC</span> <span class="o">=</span> <span class="n">AdditionalConditions</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voronoi</span><span class="p">,</span> <span class="n">bva_valences</span><span class="p">,</span> <span class="n">sites_map</span><span class="p">,</span> <span class="n">equivalent_sites</span><span class="p">,</span>
                 <span class="n">ce_list</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for the StructureEnvironments object.</span>
<span class="sd">        :param voronoi: VoronoiContainer object for the structure</span>
<span class="sd">        :param bva_valences: Valences obtained using the bond-valence analysis</span>
<span class="sd">        :param sites_map: Mapping of equivalent sites to the unequivalent sites that have been computed.</span>
<span class="sd">        :param equivalent_sites: List of list of equivalent sites of the structure</span>
<span class="sd">        :param struct_sites_to_irreducible_site_list_map: Maps the index of a site to the index of the item in the</span>
<span class="sd">        list of equivalent sites to which the site belongs.</span>
<span class="sd">        :param ce_list: List of chemical environments</span>
<span class="sd">        :param structure: Structure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span> <span class="o">=</span> <span class="n">voronoi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bva_valences</span> <span class="o">=</span> <span class="n">bva_valences</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites_map</span> <span class="o">=</span> <span class="n">sites_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equivalent_sites</span> <span class="o">=</span> <span class="n">equivalent_sites</span>
        <span class="c1">#self.struct_sites_to_irreducible_site_list_map = struct_sites_to_irreducible_site_list_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span> <span class="o">=</span> <span class="n">ce_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

<div class="viewcode-block" id="StructureEnvironments.get_csm"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.get_csm">[docs]</a>    <span class="k">def</span> <span class="nf">get_csm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="p">,</span> <span class="n">mp_symbol</span><span class="p">):</span>
        <span class="n">csms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csms</span><span class="p">(</span><span class="n">isite</span><span class="p">,</span> <span class="n">mp_symbol</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">csms</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChemenvError</span><span class="p">(</span><span class="s1">&#39;StructureEnvironments&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;get_csm&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;Number of csms for site #</span><span class="si">{}</span><span class="s1"> with &#39;</span>
                               <span class="s1">&#39;mp_symbol &quot;</span><span class="si">{}</span><span class="s1">&quot; = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">isite</span><span class="p">),</span>
                                                            <span class="n">mp_symbol</span><span class="p">,</span>
                                                            <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">csms</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">csms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="StructureEnvironments.get_csms"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.get_csms">[docs]</a>    <span class="k">def</span> <span class="nf">get_csms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="p">,</span> <span class="n">mp_symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the continuous symmetry measure(s) of site with index isite with respect to the</span>
<span class="sd">         perfect coordination environment with mp_symbol. For some environments, a given mp_symbol might not</span>
<span class="sd">         be available (if there is no voronoi parameters leading to a number of neighbours corresponding to</span>
<span class="sd">         the coordination number of environment mp_symbol). For some environments, a given mp_symbol might</span>
<span class="sd">         lead to more than one csm (when two or more different voronoi parameters lead to different neighbours</span>
<span class="sd">         but with same number of neighbours).</span>
<span class="sd">        :param isite: Index of the site</span>
<span class="sd">        :param mp_symbol: MP symbol of the perfect environment for which the csm has to be given</span>
<span class="sd">        :return: List of csms for site isite with respect to geometry mp_symbol</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">symbol_cn_mapping</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">isite</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">envs</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">]</span> <span class="k">for</span> <span class="n">envs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="n">cn</span><span class="p">]]</span></div>

<div class="viewcode-block" id="StructureEnvironments.get_environments_figure"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.get_environments_figure">[docs]</a>    <span class="k">def</span> <span class="nf">get_environments_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Coordination numbers&#39;</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                <span class="n">additional_condition</span><span class="o">=</span><span class="n">AC</span><span class="o">.</span><span class="n">ONLY_ACB</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plotting of the coordination environments of a given site for all the distfactor/angfactor regions. The</span>
<span class="sd">        chemical environments with the lowest continuous symmetry measure is shown for each distfactor/angfactor</span>
<span class="sd">        region as the value for the color of that distfactor/angfactor region (using a colormap).</span>
<span class="sd">        :param isite: Index of the site for which the plot has to be done</span>
<span class="sd">        :param plot_type: How to plot the coordinations</span>
<span class="sd">        :param title: Title for the figure</span>
<span class="sd">        :param max_dist: Maximum distance to be plotted when the plotting of the distance is set to &#39;initial_normalized&#39;</span>
<span class="sd">                         or &#39;initial_real&#39; (Warning: this is not the same meaning in both cases! In the first case,</span>
<span class="sd">                         the closest atom lies at a &quot;normalized&quot; distance of 1.0 so that 2.0 means refers to this</span>
<span class="sd">                         normalized distance while in the second case, the real distance is used)</span>
<span class="sd">        :param figsize: Size of the figure to be plotted</span>
<span class="sd">        :return: The figure object to be plotted or saved to file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">mpl</span>
            <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>
            <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">Normalize</span><span class="p">,</span> <span class="n">LinearSegmentedColormap</span><span class="p">,</span> <span class="n">ListedColormap</span>
            <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Rectangle</span><span class="p">,</span> <span class="n">Polygon</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plotting Chemical Environments requires matplotlib ... exiting &quot;plot&quot; function&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#Initializes the figure</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">subplot</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="c1">#Initializes the distance and angle parameters</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot_type</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;distance_parameter&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;initial_inverse_opposite&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                         <span class="s1">&#39;angle_parameter&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;initial_opposite&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>
        <span class="n">bounds_and_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span><span class="o">.</span><span class="n">voronoi_parameters_bounds_and_limits</span><span class="p">(</span><span class="n">isite</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">max_dist</span><span class="p">)</span>
        <span class="c1"># distance_bounds = bounds_and_limits[&#39;distance_bounds&#39;]</span>
        <span class="c1"># angle_bounds = bounds_and_limits[&#39;angle_bounds&#39;]</span>
        <span class="c1"># dist_limits = bounds_and_limits[&#39;distance_limits&#39;]</span>
        <span class="c1"># ang_limits = bounds_and_limits[&#39;angle_limits&#39;]</span>
        <span class="c1"># iac = self.voronoi.additional_conditions.index(additional_condition)</span>
        <span class="k">if</span> <span class="n">colormap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mycm</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">jet</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mycm</span> <span class="o">=</span> <span class="n">colormap</span>
        <span class="n">mymin</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">mymax</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">mymin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">mymax</span><span class="p">)</span>
        <span class="n">scalarmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">mycm</span><span class="p">)</span>

        <span class="c1">#Plot the rectangles and coordinations</span>
        <span class="n">maps_and_vertices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span><span class="o">.</span><span class="n">maps_and_surface_vertices</span><span class="p">(</span><span class="n">isite</span><span class="p">,</span>
                                                                   <span class="n">additional_condition</span><span class="o">=</span><span class="n">additional_condition</span><span class="p">,</span>
                                                                   <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maps_and_vertices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cn_maps</span> <span class="o">=</span> <span class="n">maps_and_vertices</span><span class="p">[</span><span class="s1">&#39;cn_maps&#39;</span><span class="p">]</span>
        <span class="n">bounds_and_limits</span> <span class="o">=</span> <span class="n">maps_and_vertices</span><span class="p">[</span><span class="s1">&#39;bounds_and_limits&#39;</span><span class="p">]</span>
        <span class="n">dist_limits</span> <span class="o">=</span> <span class="n">bounds_and_limits</span><span class="p">[</span><span class="s1">&#39;distance_limits&#39;</span><span class="p">]</span>
        <span class="n">ang_limits</span> <span class="o">=</span> <span class="n">bounds_and_limits</span><span class="p">[</span><span class="s1">&#39;angle_limits&#39;</span><span class="p">]</span>
        <span class="n">vertices_dist_ang</span> <span class="o">=</span> <span class="n">maps_and_vertices</span><span class="p">[</span><span class="s1">&#39;vertices_dist_ang&#39;</span><span class="p">]</span>
        <span class="n">text_info_dist_ang</span> <span class="o">=</span> <span class="n">maps_and_vertices</span><span class="p">[</span><span class="s1">&#39;text_info_dist_ang&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_cn_map</span><span class="p">,</span> <span class="n">cn_map</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cn_maps</span><span class="p">):</span>
            <span class="n">ce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="n">cn_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cn_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">mingeom</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">minimum_geometry</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mingeom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mp_symbol</span> <span class="o">=</span> <span class="n">mingeom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">csm</span> <span class="o">=</span> <span class="n">mingeom</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;symmetry_measure&#39;</span><span class="p">]</span>
                <span class="n">mycolor</span> <span class="o">=</span> <span class="n">scalarmap</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">csm</span><span class="p">)</span>
                <span class="n">myinvcolor</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">mycolor</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">mycolor</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">mycolor</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">]</span>
                <span class="n">mytext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp_symbol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cn</span> <span class="o">=</span> <span class="n">cn_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mycolor</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
                <span class="n">myinvcolor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
                <span class="n">mytext</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">vertices_dist_ang</span><span class="p">[</span><span class="n">i_cn_map</span><span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">mycolor</span><span class="p">)</span>
            <span class="n">subplot</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
            <span class="n">subplot</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mytext</span><span class="p">,</span>
                             <span class="n">xy</span><span class="o">=</span><span class="n">text_info_dist_ang</span><span class="p">[</span><span class="n">i_cn_map</span><span class="p">],</span>
                             <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">myinvcolor</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Dist: </span><span class="si">{}</span><span class="s1">, Ang: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot_type</span><span class="p">[</span><span class="s1">&#39;distance_parameter&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">plot_type</span><span class="p">[</span><span class="s1">&#39;angle_parameter&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Distance factor&#39;</span><span class="p">)</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Angle factor&#39;</span><span class="p">)</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">dist_limits</span><span class="p">)</span>
        <span class="n">subplot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ang_limits</span><span class="p">)</span>
        <span class="c1"># ax2 = subplot.twin()  # ax2 is responsible for &quot;top&quot; axis and &quot;right&quot; axis</span>
        <span class="c1"># ax2.set_xticks([0., .5*np.pi, np.pi, 1.5*np.pi, 2*np.pi])</span>
        <span class="c1"># ax2.set_xticklabels([&quot;$0$&quot;, r&quot;$\frac{1}{2}\pi$&quot;,</span>
        <span class="c1">#                      r&quot;$\pi$&quot;, r&quot;$\frac{3}{2}\pi$&quot;, r&quot;$2\pi$&quot;])</span>
        <span class="c1">#</span>
        <span class="c1"># ax2.axis[&quot;right&quot;].major_ticklabels.set_visible(False)</span>
        <span class="n">scalarmap</span><span class="o">.</span><span class="n">set_array</span><span class="p">([</span><span class="n">mymin</span><span class="p">,</span> <span class="n">mymax</span><span class="p">])</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scalarmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">subplot</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Continuous symmetry measure&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="StructureEnvironments.plot_environments"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.plot_environments">[docs]</a>    <span class="k">def</span> <span class="nf">plot_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">isite</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Coordination numbers&#39;</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                          <span class="n">additional_condition</span><span class="o">=</span><span class="n">AC</span><span class="o">.</span><span class="n">ONLY_ACB</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plotting of the coordination numbers of a given site for all the distfactor/angfactor parameters. If the</span>
<span class="sd">        chemical environments are given, a color map is added to the plot, with the lowest continuous symmetry measure</span>
<span class="sd">        as the value for the color of that distfactor/angfactor set.</span>
<span class="sd">        :param isite: Index of the site for which the plot has to be done</span>
<span class="sd">        :param plot_type: How to plot the coordinations</span>
<span class="sd">        :param title: Title for the figure</span>
<span class="sd">        :param max_dist: Maximum distance to be plotted when the plotting of the distance is set to &#39;initial_normalized&#39;</span>
<span class="sd">                         or &#39;initial_real&#39; (Warning: this is not the same meaning in both cases! In the first case,</span>
<span class="sd">                         the closest atom lies at a &quot;normalized&quot; distance of 1.0 so that 2.0 means refers to this</span>
<span class="sd">                         normalized distance while in the second case, the real distance is used)</span>
<span class="sd">        :param figsize: Size of the figure to be plotted</span>
<span class="sd">        :return: Nothing returned, just plot the figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environments_figure</span><span class="p">(</span><span class="n">isite</span><span class="o">=</span><span class="n">isite</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">,</span>
                                           <span class="n">additional_condition</span><span class="o">=</span><span class="n">additional_condition</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="StructureEnvironments.save_environments_figure"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.save_environments_figure">[docs]</a>    <span class="k">def</span> <span class="nf">save_environments_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">isite</span><span class="p">,</span> <span class="n">imagename</span><span class="o">=</span><span class="s1">&#39;image.png&#39;</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Coordination numbers&#39;</span><span class="p">,</span>
                                 <span class="n">max_dist</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">additional_condition</span><span class="o">=</span><span class="n">AC</span><span class="o">.</span><span class="n">ONLY_ACB</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environments_figure</span><span class="p">(</span><span class="n">isite</span><span class="o">=</span><span class="n">isite</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">max_dist</span><span class="o">=</span><span class="n">max_dist</span><span class="p">,</span>
                                           <span class="n">additional_condition</span><span class="o">=</span><span class="n">additional_condition</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span></div>

<div class="viewcode-block" id="StructureEnvironments.to_bv_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.to_bv_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_bv_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;neighbours_lists&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;continuous_symmetry_measures&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">coordnbs_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span><span class="o">.</span><span class="n">_unique_coordinated_neighbors</span><span class="p">[</span><span class="n">isite</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i_coordnbs</span><span class="p">,</span> <span class="n">coordnbs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coordnbs_list</span><span class="p">):</span>
                <span class="n">neighbours</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ineighb</span><span class="p">,</span> <span class="n">neighb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coordnbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;neighbour&#39;</span><span class="p">:</span> <span class="n">neighb</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                              <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="n">coordnbs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ineighb</span><span class="p">][</span><span class="s1">&#39;distance&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;normalized_distance&#39;</span><span class="p">:</span> <span class="n">coordnbs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ineighb</span><span class="p">][</span><span class="s1">&#39;weighted_distance&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;angle&#39;</span><span class="p">:</span> <span class="n">coordnbs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ineighb</span><span class="p">][</span><span class="s1">&#39;angle&#39;</span><span class="p">],</span>
                              <span class="s1">&#39;normalized_angle&#39;</span><span class="p">:</span> <span class="n">coordnbs</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">ineighb</span><span class="p">][</span><span class="s1">&#39;weighted_angle&#39;</span><span class="p">]}</span>
                    <span class="n">neighbours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
                <span class="n">ce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="n">cn</span><span class="p">][</span><span class="n">i_coordnbs</span><span class="p">]</span>
                <span class="n">mingeoms</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="n">minimum_geometries</span><span class="p">()</span>
                <span class="n">csm_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">ce</span><span class="p">:</span> <span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;symmetry_measure&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ce</span><span class="p">,</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="n">mingeoms</span><span class="p">}</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;neighbours_lists&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbours</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span><span class="s2">&quot;continuous_symmetry_measures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">csm_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>
      <span class="c1">#           - &quot;neighbour&quot;: the PeriodicSite object, as a dictionary</span>
      <span class="c1"># - &quot;distance&quot;: the distance to the site X</span>
      <span class="c1"># - &quot;angle&quot;: the angle from the site X</span>
      <span class="c1"># - &quot;normalized_distance&quot;: the normalized distance to the site X</span>
      <span class="c1"># - &quot;normalized_angle&quot;: the normalized angle from the site X</span>

<div class="viewcode-block" id="StructureEnvironments.unique_coordinated_neighbors"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.unique_coordinated_neighbors">[docs]</a>    <span class="k">def</span> <span class="nf">unique_coordinated_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cn_map</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span><span class="o">.</span><span class="n">unique_coordinated_neighbors</span><span class="p">(</span><span class="n">isite</span><span class="o">=</span><span class="n">isite</span><span class="p">,</span> <span class="n">cn_map</span><span class="o">=</span><span class="n">cn_map</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">ce_list</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">ces</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">ces</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">cn</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">voronoi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bva_valences</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">bva_valences</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sites_map</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">sites_map</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">equivalent_sites</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">equivalent_sites</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">ce_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

<div class="viewcode-block" id="StructureEnvironments.as_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bson-serializable dict representation of the StructureEnvironments object.</span>
<span class="sd">        :return: Bson-serializable dict representation of the StructureEnvironments object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ce_list_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="nb">str</span><span class="p">(</span><span class="n">cn</span><span class="p">):</span> <span class="p">[</span><span class="n">ce</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ce</span> <span class="ow">in</span> <span class="n">ce_dict</span><span class="p">[</span><span class="n">cn</span><span class="p">]]</span>
                         <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">ce_dict</span><span class="p">}</span> <span class="k">if</span> <span class="n">ce_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ce_list</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;@module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span>
                <span class="s2">&quot;@class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="s2">&quot;voronoi&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                <span class="s2">&quot;bva_valences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bva_valences</span><span class="p">,</span>
                <span class="s2">&quot;sites_map&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites_map</span><span class="p">,</span>
                <span class="s2">&quot;equivalent_sites&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">ps</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">psl</span><span class="p">]</span> <span class="k">for</span> <span class="n">psl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">equivalent_sites</span><span class="p">],</span>
                <span class="s2">&quot;ce_list&quot;</span><span class="p">:</span> <span class="n">ce_list_dict</span><span class="p">,</span>
                <span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()}</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="StructureEnvironments.from_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.StructureEnvironments.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstructs the StructureEnvironments object from a dict representation of the StructureEnvironments created</span>
<span class="sd">        using the as_dict method.</span>
<span class="sd">        :param d: dict representation of the StructureEnvironments object</span>
<span class="sd">        :return: StructureEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ce_list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">ce_dict</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">ce_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">cn</span><span class="p">):</span> <span class="p">[</span><span class="n">ChemicalEnvironments</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">ced</span><span class="p">)</span> <span class="k">for</span> <span class="n">ced</span> <span class="ow">in</span> <span class="n">ce_dict</span><span class="p">[</span><span class="n">cn</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">ce_dict</span><span class="p">}</span> <span class="k">for</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ce_list&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">DetailedVoronoiContainer</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;voronoi&#39;</span><span class="p">]),</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bva_valences&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sites_map&#39;</span><span class="p">],</span>
                   <span class="p">[[</span><span class="n">PeriodicSite</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span> <span class="k">for</span> <span class="n">psd</span> <span class="ow">in</span> <span class="n">psl</span><span class="p">]</span> <span class="k">for</span> <span class="n">psl</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;equivalent_sites&#39;</span><span class="p">]],</span>
                   <span class="n">ce_list</span><span class="p">,</span> <span class="n">Structure</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="LightStructureEnvironments"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments">[docs]</a><span class="k">class</span> <span class="nc">LightStructureEnvironments</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class used to store the chemical environments of a given structure obtained from a given ChemenvStrategy. Currently,</span>
<span class="sd">    only strategies leading to the determination of a unique environment for each site is allowed</span>
<span class="sd">    This class does not store all the information contained in the StructureEnvironments object, only the coordination</span>
<span class="sd">    environment found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DELTA_MAX_OXIDATION_STATE</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">DEFAULT_STATISTICS_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;anion_list&#39;</span><span class="p">,</span> <span class="s1">&#39;anion_atom_list&#39;</span><span class="p">,</span> <span class="s1">&#39;cation_list&#39;</span><span class="p">,</span> <span class="s1">&#39;cation_atom_list&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;neutral_list&#39;</span><span class="p">,</span> <span class="s1">&#39;neutral_atom_list&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;atom_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;bva_ion_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;structure_ion_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;ion_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;fraction_atom_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;fraction_bva_ion_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;fraction_structure_ion_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;fraction_ion_coordination_environments_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;coordination_environments_atom_present&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;coordination_environments_ion_present&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">structure_environments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bva_valences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">coordination_environments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setup_neighbors_by_indices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">neighbors_by_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor for the LightStructureEnvironments object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uniquely_determined_coordination_environments</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">uniquely_determines_coordination_environments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">coordination_environments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span> <span class="o">=</span> <span class="n">coordination_environments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span> <span class="o">=</span> <span class="n">neighbors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">=</span> <span class="n">bva_valences</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
            <span class="k">if</span> <span class="n">neighbors_by_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span> <span class="o">=</span> <span class="n">neighbors_by_indices</span>
            <span class="k">if</span> <span class="n">setup_neighbors_by_indices</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_setup_neighbors_by_indices</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">structure_environments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;coordination_environments and structure_environments are both None&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">set_structure_environments</span><span class="p">(</span><span class="n">structure_environments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure_environments</span><span class="o">.</span><span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">=</span> <span class="n">structure_environments</span><span class="o">.</span><span class="n">bva_valences</span> <span class="k">if</span> <span class="n">bva_valences</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">bva_valences</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structure_environments</span><span class="o">.</span><span class="n">structure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">structure_environments</span><span class="o">.</span><span class="n">ce_list</span><span class="p">[</span><span class="n">isite</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="k">continue</span>
            <span class="n">site_ce_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">get_site_ce_fractions_and_neighbors</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">site_ce_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">({})</span>
                <span class="k">continue</span>
            <span class="c1">#This contains a dictionary with keys &quot;ce&quot; and &quot;neighbors&quot;.</span>
            <span class="c1">#  In site_ce_list[&quot;ce&quot;], a list of dictionaries with each possible environment determined by the strategy</span>
            <span class="c1">#    In each dictionary, the following keys exist : mp_symbol, fraction, cn_map and csm</span>
            <span class="c1">#  In site_ce_list[&quot;neighbors&quot;], a dictionary with the corresponding neighbors (as a list of pymatgen&#39;s</span>
            <span class="c1">#    Site objects) for each cn_map is stored</span>
            <span class="n">ce_piece_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">neighbors_list</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ce_piece</span> <span class="ow">in</span> <span class="n">site_ce_list</span><span class="p">[</span><span class="s1">&#39;ce&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;cn_map&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">neighbors_list</span><span class="p">:</span>
                    <span class="n">neighbors_list</span><span class="p">[</span><span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;cn_map&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">site_ce_list</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">][</span><span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;cn_map&#39;</span><span class="p">]]</span>
                <span class="n">ce_piece_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">:</span> <span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;mp_symbol&#39;</span><span class="p">],</span> <span class="s1">&#39;fraction&#39;</span><span class="p">:</span> <span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;csm&#39;</span><span class="p">:</span> <span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;csm&#39;</span><span class="p">],</span> <span class="s1">&#39;cn_map&#39;</span><span class="p">:</span> <span class="n">ce_piece</span><span class="p">[</span><span class="s1">&#39;cn_map&#39;</span><span class="p">]}</span>
                <span class="n">ce_piece_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ce_piece_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ce_piece_dict_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neighbors_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_neighbors_by_indices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_neighbors_by_indices</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_neighbors_by_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">uniquely_determines_coordination_environments</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Should use a strategy that uniquely determines coordination environments !&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">isite_this_site</span><span class="p">,</span> <span class="n">this_site_neighbors_all_cn_maps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite_this_site</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">cn_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite_this_site</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cn_map&#39;</span><span class="p">]</span>
            <span class="n">this_site_neighbors</span> <span class="o">=</span> <span class="n">this_site_neighbors_all_cn_maps</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">cn_map</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">this_site_neighbors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">this_site_neighbors_indices</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">neighbor</span> <span class="ow">in</span> <span class="n">this_site_neighbors</span><span class="p">:</span>
                    <span class="n">ineighbor</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">):</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">for</span> <span class="n">tolerance</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">site</span><span class="o">.</span><span class="n">is_periodic_image</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span> <span class="n">check_lattice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">):</span>
                                <span class="n">ineighbor</span> <span class="o">=</span> <span class="n">isite</span>
                                <span class="n">diff</span> <span class="o">=</span> <span class="n">neighbor</span><span class="o">.</span><span class="n">frac_coords</span> <span class="o">-</span> <span class="n">site</span><span class="o">.</span><span class="n">frac_coords</span>
                                <span class="n">image_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
                                <span class="c1">#if np.allclose(image_cell, np.zeros(3, np.int)):</span>
                                <span class="c1">#    image_cell = 0</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ChemenvError</span><span class="p">(</span><span class="s1">&#39;LightStructureEnvironments&#39;</span><span class="p">,</span> <span class="s1">&#39;__init__&#39;</span><span class="p">,</span> <span class="s1">&#39;Site indices not found&#39;</span><span class="p">)</span>
                    <span class="n">this_site_neighbors_indices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ineighbor</span><span class="p">,</span> <span class="n">image_cell</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">this_site_neighbors_indices</span><span class="p">)</span>

<div class="viewcode-block" id="LightStructureEnvironments.setup_statistic_lists"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.setup_statistic_lists">[docs]</a>    <span class="k">def</span> <span class="nf">setup_statistic_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;anion_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                                    <span class="c1"># OK</span>
                                <span class="s1">&#39;anion_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                                <span class="c1"># OK</span>
                                <span class="s1">&#39;anion_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                               <span class="c1"># OK</span>
                                <span class="s1">&#39;anion_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                           <span class="c1"># OK</span>
                                <span class="s1">&#39;cation_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                                   <span class="c1"># OK</span>
                                <span class="s1">&#39;cation_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                               <span class="c1"># OK</span>
                                <span class="s1">&#39;cation_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                              <span class="c1"># OK</span>
                                <span class="s1">&#39;cation_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                          <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_anion_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                          <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_anion_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                      <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_anion_undefined_oxidation_list&#39;</span><span class="p">:</span> <span class="p">[],</span>                      <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_anion_undefined_oxidation_occupation&#39;</span><span class="p">:</span> <span class="p">[],</span>                <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_anion_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                     <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_anion_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                 <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_cation_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                         <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_cation_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                     <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_cation_undefined_oxidation_list&#39;</span><span class="p">:</span> <span class="p">[],</span>                     <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_cation_undefined_oxidation_occupation&#39;</span><span class="p">:</span> <span class="p">[],</span>               <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_cation_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                    <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_cation_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_anion_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                                <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_anion_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                            <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_anion_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                           <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_anion_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                       <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_cation_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                               <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_cation_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                           <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_cation_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                          <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_cation_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                      <span class="c1"># OK</span>
                                <span class="s1">&#39;neutral_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                                  <span class="c1"># OK</span>
                                <span class="s1">&#39;neutral_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                              <span class="c1"># OK</span>
                                <span class="s1">&#39;neutral_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                             <span class="c1"># OK</span>
                                <span class="s1">&#39;neutral_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                         <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_neutral_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                        <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_neutral_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                    <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_neutral_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                   <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_neutral_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                               <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_neutral_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                              <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_neutral_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                          <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_neutral_atom_list&#39;</span><span class="p">:</span> <span class="p">{},</span>                                         <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_neutral_atom_number&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>                                     <span class="c1"># OK</span>
                                <span class="s1">&#39;atom_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                        <span class="c1"># OK</span>
                                <span class="s1">&#39;structure_ion_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>               <span class="c1"># OK</span>
                                <span class="s1">&#39;bva_ion_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                     <span class="c1"># OK</span>
                                <span class="s1">&#39;ion_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                         <span class="c1"># OK</span>
                                <span class="s1">&#39;coordination_environments_structure_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>               <span class="c1"># OK</span>
                                <span class="s1">&#39;coordination_environments_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                         <span class="c1"># OK</span>
                                <span class="s1">&#39;coordination_environments_bva_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                     <span class="c1"># OK</span>
                                <span class="s1">&#39;coordination_environments_atom_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                        <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_bva_ion_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>            <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_structure_ion_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>      <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_ion_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_atom_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{},</span>               <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_coordination_environments_bva_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>            <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_coordination_environments_structure_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>      <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_coordination_environments_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                <span class="c1"># OK</span>
                                <span class="s1">&#39;fraction_coordination_environments_atom_present&#39;</span><span class="p">:</span> <span class="p">{},</span>               <span class="c1"># OK</span>
                                <span class="s1">&#39;count_bva_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                                         <span class="c1"># OK</span>
                                <span class="s1">&#39;count_structure_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                                   <span class="c1"># OK</span>
                                <span class="s1">&#39;count_ion_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                                             <span class="c1"># OK</span>
                                <span class="s1">&#39;count_atom_present&#39;</span><span class="p">:</span> <span class="p">{},</span>                                            <span class="c1"># OK</span>
                                <span class="s1">&#39;count_coordination_environments_present&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="n">structure_has_species</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Specie</span><span class="p">)</span>
        <span class="n">atom_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;atom_coordination_environments_present&#39;</span><span class="p">]</span>
        <span class="n">ce_atom_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;coordination_environments_atom_present&#39;</span><span class="p">]</span>
        <span class="n">fraction_atom_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;fraction_atom_coordination_environments_present&#39;</span><span class="p">]</span>
        <span class="n">fraction_ce_atom_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;fraction_coordination_environments_atom_present&#39;</span><span class="p">]</span>
        <span class="n">count_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;count_atom_present&#39;</span><span class="p">]</span>
        <span class="n">count_ce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;count_coordination_environments_present&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">):</span>
            <span class="c1">#Building anion and cation list</span>
            <span class="n">site_species</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bva_oxistates&#39;</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="s1">&#39;structure_oxistates&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">valence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span><span class="p">[</span><span class="n">isite</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">valence</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_list&#39;</span><span class="p">]</span>
                        <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_atom_list&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">valence</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_list&#39;</span><span class="p">]</span>
                        <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_atom_list&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_neutral_list&#39;</span><span class="p">]</span>
                        <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_neutral_atom_list&#39;</span><span class="p">]</span>
                    <span class="n">strspecie</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Specie</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">valence</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">strspecie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specielist</span><span class="p">:</span>
                        <span class="n">specielist</span><span class="p">[</span><span class="n">strspecie</span><span class="p">]</span> <span class="o">=</span> <span class="n">occ</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">specielist</span><span class="p">[</span><span class="n">strspecie</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                    <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomlist</span><span class="p">:</span>
                        <span class="n">atomlist</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">occ</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">atomlist</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                    <span class="n">site_species</span><span class="p">[</span><span class="s1">&#39;bva_oxistates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">valence</span><span class="p">,</span> <span class="n">occ</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_atom_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_atom_list&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">structure_has_species</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">oxi_state_rounded</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">oxi_state</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">oxi_state</span><span class="p">,</span> <span class="n">oxi_state_rounded</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DELTA_MAX_OXIDATION_STATE</span><span class="p">):</span>
                        <span class="n">valence</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oxi_state_rounded</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">valence</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_list&#39;</span><span class="p">]</span>
                            <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_atom_list&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">valence</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_list&#39;</span><span class="p">]</span>
                            <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_atom_list&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_neutral_list&#39;</span><span class="p">]</span>
                            <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_neutral_atom_list&#39;</span><span class="p">]</span>
                        <span class="n">strspecie</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Specie</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">valence</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">strspecie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specielist</span><span class="p">:</span>
                            <span class="n">specielist</span><span class="p">[</span><span class="n">strspecie</span><span class="p">]</span> <span class="o">=</span> <span class="n">occ</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">specielist</span><span class="p">[</span><span class="n">strspecie</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomlist</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">occ</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                        <span class="n">site_species</span><span class="p">[</span><span class="s1">&#39;structure_oxistates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">valence</span><span class="p">,</span> <span class="n">occ</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">valence</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">oxi_state</span>
                        <span class="k">if</span> <span class="n">valence</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_undefined_oxidation_list&#39;</span><span class="p">]</span>
                            <span class="n">specieocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_undefined_oxidation_occupation&#39;</span><span class="p">]</span>
                            <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_atom_list&#39;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">valence</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">specielist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_undefined_oxidation_list&#39;</span><span class="p">]</span>
                            <span class="n">specieocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_undefined_oxidation_occupation&#39;</span><span class="p">]</span>
                            <span class="n">atomlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_atom_list&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Should not be here ...&#39;</span><span class="p">)</span>
                        <span class="n">strspecie</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Specie</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span> <span class="n">valence</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">strspecie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">specielist</span><span class="p">:</span>
                            <span class="n">specielist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strspecie</span><span class="p">)</span>
                            <span class="n">specieocc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occ</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">specie_index</span> <span class="o">=</span> <span class="n">specielist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">strspecie</span><span class="p">)</span>
                            <span class="n">specieocc</span><span class="p">[</span><span class="n">specie_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                        <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomlist</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="n">occ</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_list&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_undefined_oxidation_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_atom_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_list&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_undefined_oxidation_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_atom_list&#39;</span><span class="p">])</span>
            <span class="c1"># for prefix in [&#39;structure_&#39;, &#39;bva_&#39;]:</span>
            <span class="c1">#     if ((prefix == &#39;bva_&#39; and self._bva_valences != &#39;undefined&#39;) or</span>
            <span class="c1">#             (prefix == &#39;structure_&#39; and structure_has_species)):</span>
            <span class="c1">#         for sp, occ in site.species_and_occu.items():</span>
            <span class="c1">#             valence = self._bva_valences[isite] if prefix == &#39;bva_&#39; else sp.oxi_state</span>
            <span class="c1">#             if valence &lt; 0:</span>
            <span class="c1">#                 specielist = self.statistics_dict[&#39;{}anion_list&#39;.format(prefix)]</span>
            <span class="c1">#                 atomlist = self.statistics_dict[&#39;{}anion_atom_list&#39;.format(prefix)]</span>
            <span class="c1">#             elif valence &gt; 0:</span>
            <span class="c1">#                 specielist = self.statistics_dict[&#39;{}cation_list&#39;.format(prefix)]</span>
            <span class="c1">#                 atomlist = self.statistics_dict[&#39;{}cation_atom_list&#39;.format(prefix)]</span>
            <span class="c1">#             else:</span>
            <span class="c1">#                 specielist = self.statistics_dict[&#39;{}neutral_list&#39;.format(prefix)]</span>
            <span class="c1">#                 atomlist = self.statistics_dict[&#39;{}neutral_atom_list&#39;.format(prefix)]</span>
            <span class="c1">#             strspecie = str(Specie(sp.symbol, valence))</span>
            <span class="c1">#             if strspecie not in specielist:</span>
            <span class="c1">#                 specielist[strspecie] = occ</span>
            <span class="c1">#             else:</span>
            <span class="c1">#                 specielist[strspecie] += occ</span>
            <span class="c1">#             if sp.symbol not in atomlist:</span>
            <span class="c1">#                 atomlist[sp.symbol] = occ</span>
            <span class="c1">#             else:</span>
            <span class="c1">#                 atomlist[sp.symbol] += occ</span>
            <span class="c1">#             site_species[&#39;{}oxistates&#39;.format(prefix)].append((sp.symbol, valence, occ))</span>
            <span class="c1">#         self.statistics_dict[&#39;{}anion_number&#39;.format(prefix)] = len(self.statistics_dict[&#39;{}anion_list&#39;.format(prefix)])</span>
            <span class="c1">#         self.statistics_dict[&#39;{}anion_atom_number&#39;.format(prefix)] = len(self.statistics_dict[&#39;{}anion_atom_list&#39;.format(prefix)])</span>
            <span class="c1">#         self.statistics_dict[&#39;{}cation_number&#39;.format(prefix)] = len(self.statistics_dict[&#39;{}cation_list&#39;.format(prefix)])</span>
            <span class="c1">#         self.statistics_dict[&#39;{}cation_atom_number&#39;.format(prefix)] = len(self.statistics_dict[&#39;{}cation_atom_list&#39;.format(prefix)])</span>

            <span class="c1">#Building environments lists</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">site_envs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">ce_piece_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">],</span> <span class="n">ce_piece_dict</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">ce_piece_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">site_envs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">count_ce</span><span class="p">:</span>
                        <span class="n">count_ce</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">count_ce</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fraction</span>
                <span class="k">for</span> <span class="n">sp</span><span class="p">,</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species_and_occu</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">elmt</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbol</span>
                    <span class="k">if</span> <span class="n">elmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_stat</span><span class="p">:</span>
                        <span class="n">atom_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">count_atoms</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">count_atoms</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                    <span class="k">for</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">site_envs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]:</span>
                            <span class="n">atom_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                        <span class="n">atom_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span> <span class="o">*</span> <span class="n">fraction</span>
                        <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_atom_stat</span><span class="p">:</span>
                            <span class="n">ce_atom_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">elmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_atom_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]:</span>
                            <span class="n">ce_atom_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">ce_atom_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span> <span class="o">*</span> <span class="n">fraction</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
                    <span class="n">ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_ion_coordination_environments_present&#39;</span><span class="p">]</span>
                    <span class="n">ce_ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;coordination_environments_bva_ion_present&#39;</span><span class="p">]</span>
                    <span class="n">count_ions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;count_bva_ion_present&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">elmt</span><span class="p">,</span> <span class="n">oxi_state</span><span class="p">,</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">site_species</span><span class="p">[</span><span class="s1">&#39;bva_oxistates&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">elmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="p">:</span>
                            <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="n">oxi_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]:</span>
                            <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                        <span class="k">for</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">site_envs</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]:</span>
                                <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">][</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">][</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span> <span class="o">*</span> <span class="n">fraction</span>
                            <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="p">:</span>
                                <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="n">elmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]:</span>
                                <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="n">oxi_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]:</span>
                                <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span> <span class="o">*</span> <span class="n">fraction</span>
                <span class="k">if</span> <span class="n">structure_has_species</span><span class="p">:</span>
                    <span class="n">ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_ion_coordination_environments_present&#39;</span><span class="p">]</span>
                    <span class="n">ce_ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;coordination_environments_structure_ion_present&#39;</span><span class="p">]</span>
                    <span class="n">count_ions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;count_structure_ion_present&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">elmt</span><span class="p">,</span> <span class="n">oxi_state</span><span class="p">,</span> <span class="n">occ</span> <span class="ow">in</span> <span class="n">site_species</span><span class="p">[</span><span class="s1">&#39;structure_oxistates&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">elmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="p">:</span>
                            <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">oxi_state_rounded</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">oxi_state</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">oxi_state</span><span class="p">,</span> <span class="n">oxi_state_rounded</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">DELTA_MAX_OXIDATION_STATE</span><span class="p">):</span>
                            <span class="n">my_oxi_state</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oxi_state_rounded</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">my_oxi_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]:</span>
                                <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span>
                            <span class="k">for</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">site_envs</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">fraction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">]:</span>
                                    <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">][</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                                <span class="n">ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">][</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span> <span class="o">*</span> <span class="n">fraction</span>
                                <span class="k">if</span> <span class="n">ce_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="p">:</span>
                                    <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">if</span> <span class="n">elmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]:</span>
                                    <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">if</span> <span class="n">my_oxi_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]:</span>
                                    <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                                <span class="n">ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">][</span><span class="n">my_oxi_state</span><span class="p">]</span> <span class="o">+=</span> <span class="n">occ</span> <span class="o">*</span> <span class="n">fraction</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1">#TODO: make something slightly better here ... like put the fractional oxidation states</span>
                            <span class="c1">#somewhere ...</span>
                            <span class="k">continue</span>
                <span class="c1"># for prefix in [&#39;structure_&#39;, &#39;bva_&#39;]:</span>
                <span class="c1">#     if prefix == &#39;bva_&#39; and self._bva_valences == &#39;undefined&#39;:</span>
                <span class="c1">#         continue</span>
                <span class="c1">#     elif prefix == &#39;structure_&#39; and not structure_has_species:</span>
                <span class="c1">#         continue</span>
                <span class="c1">#     ion_stat = self.statistics_dict[&#39;{}ion_coordination_environments_present&#39;.format(prefix)]</span>
                <span class="c1">#     ce_ion_stat = self.statistics_dict[&#39;coordination_environments_{}ion_present&#39;.format(prefix)]</span>
                <span class="c1">#     count_ions = self.statistics_dict[&#39;count_{}ion_present&#39;.format(prefix)]</span>
                <span class="c1">#     for elmt, oxi_state, occ in site_species[&#39;{}oxistates&#39;.format(prefix)]:</span>
                <span class="c1">#         if elmt not in ion_stat:</span>
                <span class="c1">#             ion_stat[elmt] = {}</span>
                <span class="c1">#             count_ions[elmt] = {}</span>
                <span class="c1">#         if oxi_state not in ion_stat[elmt]:</span>
                <span class="c1">#             ion_stat[elmt][oxi_state] = {}</span>
                <span class="c1">#             count_ions[elmt][oxi_state] = 0.0</span>
                <span class="c1">#         count_ions[elmt][oxi_state] += occ</span>
                <span class="c1">#         for ce_symbol, fraction in site_envs:</span>
                <span class="c1">#             if fraction is None:</span>
                <span class="c1">#                 continue</span>
                <span class="c1">#             if ce_symbol not in ion_stat[elmt][oxi_state]:</span>
                <span class="c1">#                 ion_stat[elmt][oxi_state][ce_symbol] = 0.0</span>
                <span class="c1">#             ion_stat[elmt][oxi_state][ce_symbol] += occ * fraction</span>
                <span class="c1">#             if ce_symbol not in ce_ion_stat:</span>
                <span class="c1">#                 ce_ion_stat[ce_symbol] = {}</span>
                <span class="c1">#             if elmt not in ce_ion_stat[ce_symbol]:</span>
                <span class="c1">#                 ce_ion_stat[ce_symbol][elmt] = {}</span>
                <span class="c1">#             if oxi_state not in ce_ion_stat[ce_symbol][elmt]:</span>
                <span class="c1">#                 ce_ion_stat[ce_symbol][elmt][oxi_state] = 0.0</span>
                <span class="c1">#             ce_ion_stat[ce_symbol][elmt][oxi_state] += occ * fraction</span>
        <span class="k">for</span> <span class="n">elmt</span><span class="p">,</span> <span class="n">envs</span> <span class="ow">in</span> <span class="n">atom_stat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sumelement</span> <span class="o">=</span> <span class="n">count_atoms</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span>
            <span class="n">fraction_atom_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">env</span><span class="p">:</span> <span class="n">fraction</span> <span class="o">/</span> <span class="n">sumelement</span> <span class="k">for</span> <span class="n">env</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">envs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="n">ce_atom_stat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sumsymbol</span> <span class="o">=</span> <span class="n">count_ce</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span>
            <span class="n">fraction_ce_atom_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">atom</span><span class="p">:</span> <span class="n">fraction</span> <span class="o">/</span> <span class="n">sumsymbol</span> <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">atoms</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;structure_&#39;</span><span class="p">,</span> <span class="s1">&#39;bva_&#39;</span><span class="p">]:</span>
            <span class="n">ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">ion_coordination_environments_present&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
            <span class="n">fraction_ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;fraction_</span><span class="si">{}</span><span class="s1">ion_coordination_environments_present&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
            <span class="n">ce_ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;coordination_environments_</span><span class="si">{}</span><span class="s1">ion_present&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
            <span class="n">fraction_ce_ion_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;fraction_coordination_environments_</span><span class="si">{}</span><span class="s1">ion_present&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
            <span class="n">count_ions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;count_</span><span class="si">{}</span><span class="s1">ion_present&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;bva_&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">prefix</span> <span class="o">==</span> <span class="s1">&#39;structure_&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">structure_has_species</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">elmt</span><span class="p">,</span> <span class="n">oxi_states_envs</span> <span class="ow">in</span> <span class="n">ion_stat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fraction_ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">oxi_state</span><span class="p">,</span> <span class="n">envs</span> <span class="ow">in</span> <span class="n">oxi_states_envs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">sumspecie</span> <span class="o">=</span> <span class="n">count_ions</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span>
                    <span class="n">fraction_ion_stat</span><span class="p">[</span><span class="n">elmt</span><span class="p">][</span><span class="n">oxi_state</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">env</span><span class="p">:</span> <span class="n">fraction</span> <span class="o">/</span> <span class="n">sumspecie</span>
                                                          <span class="k">for</span> <span class="n">env</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">envs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">ions</span> <span class="ow">in</span> <span class="n">ce_ion_stat</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fraction_ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">sum_ce</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">oxistates</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="k">for</span> <span class="n">elmt</span><span class="p">,</span> <span class="n">oxistates</span> <span class="ow">in</span> <span class="n">ions</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
                <span class="k">for</span> <span class="n">elmt</span><span class="p">,</span> <span class="n">oxistates</span> <span class="ow">in</span> <span class="n">ions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">fraction_ce_ion_stat</span><span class="p">[</span><span class="n">ce_symbol</span><span class="p">][</span><span class="n">elmt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">oxistate</span><span class="p">:</span> <span class="n">fraction</span> <span class="o">/</span> <span class="n">sum_ce</span>
                                                             <span class="k">for</span> <span class="n">oxistate</span><span class="p">,</span> <span class="n">fraction</span> <span class="ow">in</span> <span class="n">oxistates</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">ceip</span> <span class="o">=</span> <span class="s1">&#39;coordination_environments_ion_present&#39;</span>
        <span class="n">icep</span> <span class="o">=</span> <span class="s1">&#39;ion_coordination_environments_present&#39;</span>
        <span class="n">fceip</span> <span class="o">=</span> <span class="s1">&#39;fraction_coordination_environments_ion_present&#39;</span>
        <span class="n">ficep</span> <span class="o">=</span> <span class="s1">&#39;fraction_ion_coordination_environments_present&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">!=</span> <span class="s1">&#39;undefined&#39;</span><span class="p">:</span>
            <span class="n">cebip</span> <span class="o">=</span> <span class="s1">&#39;coordination_environments_bva_ion_present&#39;</span>
            <span class="n">bicep</span> <span class="o">=</span> <span class="s1">&#39;bva_ion_coordination_environments_present&#39;</span>
            <span class="n">fcebip</span> <span class="o">=</span> <span class="s1">&#39;fraction_coordination_environments_bva_ion_present&#39;</span>
            <span class="n">fbicep</span> <span class="o">=</span> <span class="s1">&#39;fraction_bva_ion_coordination_environments_present&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_atom_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_atom_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_atom_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_atom_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_anion_atom_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;bva_cation_atom_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">ceip</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">cebip</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">icep</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">bicep</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">fceip</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">fcebip</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">ficep</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">fbicep</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cesip</span> <span class="o">=</span> <span class="s1">&#39;coordination_environments_structure_ion_present&#39;</span>
            <span class="n">sicep</span> <span class="o">=</span> <span class="s1">&#39;structure_ion_coordination_environments_present&#39;</span>
            <span class="n">fcesip</span> <span class="o">=</span> <span class="s1">&#39;fraction_coordination_environments_structure_ion_present&#39;</span>
            <span class="n">fsicep</span> <span class="o">=</span> <span class="s1">&#39;fraction_structure_ion_coordination_environments_present&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_atom_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_atom_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_atom_list&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_atom_list&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_anion_atom_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;cation_atom_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;structure_cation_atom_number&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">ceip</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">cesip</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">icep</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">sicep</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">fceip</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">fcesip</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">ficep</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">fsicep</span><span class="p">])</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.site_has_clear_environment"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.site_has_clear_environment">[docs]</a>    <span class="k">def</span> <span class="nf">site_has_clear_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">]]</span>
        <span class="n">maxfraction</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">maxfraction</span> <span class="o">&gt;</span> <span class="n">min_fraction</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.structure_has_clear_environments_for_element"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.structure_has_clear_environments_for_element">[docs]</a>    <span class="k">def</span> <span class="nf">structure_has_clear_environments_for_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site_ces</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">site_ces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">[</span><span class="n">isite</span><span class="p">]</span><span class="o">.</span><span class="n">species_and_occu</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_has_clear_environment</span><span class="p">(</span><span class="n">isite</span><span class="o">=</span><span class="n">isite</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="n">min_fraction</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.structure_has_clear_environments"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.structure_has_clear_environments">[docs]</a>    <span class="k">def</span> <span class="nf">structure_has_clear_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site_ces</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">site_ces</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_has_clear_environment</span><span class="p">(</span><span class="n">isite</span><span class="o">=</span><span class="n">isite</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="n">min_fraction</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.get_site_info_for_specie_ce"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.get_site_info_for_specie_ce">[docs]</a>    <span class="k">def</span> <span class="nf">get_site_info_for_specie_ce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specie</span><span class="p">,</span> <span class="n">ce_symbol</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">specie</span><span class="o">.</span><span class="n">symbol</span>
        <span class="n">oxi_state</span> <span class="o">=</span> <span class="n">specie</span><span class="o">.</span><span class="n">oxi_state</span>
        <span class="n">isites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">csms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species_and_occu</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">oxi_state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span><span class="p">[</span><span class="n">isite</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ce_symbol</span> <span class="o">==</span> <span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]:</span>
                            <span class="n">isites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isite</span><span class="p">)</span>
                            <span class="n">csms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">])</span>
                            <span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.get_site_info_for_specie_allces"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.get_site_info_for_specie_allces">[docs]</a>    <span class="k">def</span> <span class="nf">get_site_info_for_specie_allces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specie</span><span class="p">,</span> <span class="n">min_fraction</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="n">allces</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">specie</span><span class="o">.</span><span class="n">symbol</span>
        <span class="n">oxi_state</span> <span class="o">=</span> <span class="n">specie</span><span class="o">.</span><span class="n">oxi_state</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span> <span class="ow">in</span> <span class="p">[</span><span class="n">sp</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species_and_occu</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">oxi_state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span><span class="p">[</span><span class="n">isite</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_fraction</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allces</span><span class="p">:</span>
                            <span class="n">allces</span><span class="p">[</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;isites&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;fractions&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;csms&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                        <span class="n">allces</span><span class="p">[</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]][</span><span class="s1">&#39;isites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isite</span><span class="p">)</span>
                        <span class="n">allces</span><span class="p">[</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]][</span><span class="s1">&#39;fractions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;fraction&#39;</span><span class="p">])</span>
                        <span class="n">allces</span><span class="p">[</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]][</span><span class="s1">&#39;csms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;csm&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">allces</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.get_statistics"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.get_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statistics_fields</span><span class="o">=</span><span class="n">DEFAULT_STATISTICS_FIELDS</span><span class="p">,</span> <span class="n">bson_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_statistic_lists</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bson_compatible</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">jsanitize</span><span class="p">({</span><span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">statistics_fields</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">statistics_fields</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">dd</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.contains_only_one_anion_atom"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.contains_only_one_anion_atom">[docs]</a>    <span class="k">def</span> <span class="nf">contains_only_one_anion_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anion_atom</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_atom_list&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
                <span class="n">anion_atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_atom_list&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.contains_only_one_anion"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.contains_only_one_anion">[docs]</a>    <span class="k">def</span> <span class="nf">contains_only_one_anion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anion</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_list&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">anion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics_dict</span><span class="p">[</span><span class="s1">&#39;anion_list&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.site_contains_environment"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.site_contains_environment">[docs]</a>    <span class="k">def</span> <span class="nf">site_contains_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">isite</span><span class="p">,</span> <span class="n">ce_symbol</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ce_symbol</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ce_dict</span><span class="p">[</span><span class="s1">&#39;ce_symbol&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ce_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">[</span><span class="n">isite</span><span class="p">]]</span></div>

<div class="viewcode-block" id="LightStructureEnvironments.structure_contains_atom_environment"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.structure_contains_atom_environment">[docs]</a>    <span class="k">def</span> <span class="nf">structure_contains_atom_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_symbol</span><span class="p">,</span> <span class="n">ce_symbol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether the structure contains a given atom in a given environment</span>
<span class="sd">        :param atom_symbol: Symbol of the atom</span>
<span class="sd">        :param ce_symbol: Symbol of the coordination environment</span>
<span class="sd">        :return: True if the coordination environment is found, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">atom_symbol</span><span class="p">)</span> <span class="ow">in</span> <span class="n">site</span><span class="o">.</span><span class="n">species_and_occu</span><span class="o">.</span>
                    <span class="n">element_composition</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">site_contains_environment</span><span class="p">(</span><span class="n">isite</span><span class="p">,</span> <span class="n">ce_symbol</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordination_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Coordination environments determined by the strategy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uniquely_determined_coordination_environments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        True if the coordination environments are uniquely determined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uniquely_determined_coordination_environments</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Neighbors determined by the strategy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neighbors_by_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Neighbors by indices and image cell determined by the strategy</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_neighbors_by_indices</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors_by_indices</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Structure</span>
<span class="sd">        :return: Structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Equality method that checks if the LightStructureEnvironments object is equal to another</span>
<span class="sd">        LightStructureEnvironments object. Two LightStructureEnvironments objects are equal if the strategy used</span>
<span class="sd">        is the same, if the structure is the same, if the valences used in the strategies are the same, if the</span>
<span class="sd">        coordination environments and the neighbours determined by the strategy are the same</span>
<span class="sd">        :param other: LightStructureEnvironments object to compare with</span>
<span class="sd">        :return: True if both objects are equal, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_strategy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_structure</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_bva_valences</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_coordination_environments</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_neighbors</span><span class="p">)</span>

<div class="viewcode-block" id="LightStructureEnvironments.as_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bson-serializable dict representation of the LightStructureEnvironments object.</span>
<span class="sd">        :return: Bson-serializable dict representation of the LightStructureEnvironments object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;@module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span>
                <span class="s2">&quot;@class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                <span class="s2">&quot;structure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                <span class="s2">&quot;bva_valences&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bva_valences</span><span class="p">,</span>
                <span class="s2">&quot;coordination_environments&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordination_environments</span><span class="p">,</span>
                <span class="s2">&quot;neighbors&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">_</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn_map</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cn_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="p">[</span><span class="n">ps</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">neighbors</span><span class="p">]</span>
                               <span class="k">for</span> <span class="n">cn_map</span><span class="p">,</span> <span class="n">neighbors</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbors</span><span class="p">[</span><span class="n">isite</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                              <span class="k">for</span> <span class="n">isite</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_structure</span><span class="p">))],</span>
                <span class="s2">&quot;neighbors_by_indices&quot;</span><span class="p">:</span> <span class="n">jsanitize</span><span class="p">([</span><span class="kc">None</span> <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                                                   <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">neighbors_by_indices</span><span class="p">])}</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="LightStructureEnvironments.from_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.LightStructureEnvironments.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstructs the LightStructureEnvironments object from a dict representation of the</span>
<span class="sd">        LightStructureEnvironments created using the as_dict method.</span>
<span class="sd">        :param d: dict representation of the LightStructureEnvironments object</span>
<span class="sd">        :return: LightStructureEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="p">[{(</span><span class="nb">int</span><span class="p">(</span><span class="n">cnmap</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">cnmap</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])):</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">cnmap_neighbours</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">cnmap</span><span class="p">,</span> <span class="n">cnmap_neighbours</span> <span class="ow">in</span> <span class="n">neighbs_site</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">neighbs_site</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neighbors&#39;</span><span class="p">]]</span>
        <span class="n">coordination_environments</span> <span class="o">=</span> <span class="p">[[{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;cn_map&#39;</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                                      <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ces_site</span><span class="p">]</span> <span class="k">for</span> <span class="n">ces_site</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coordination_environments&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s1">&#39;neighbors_by_indices&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">neighbors_by_indices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;neighbors_by_indices&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">neighbors_by_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">neighbors_by_indices</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">nb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">))</span> <span class="k">for</span> <span class="n">nb</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>
            <span class="c1"># neighbors_by_indices = [None if item is None else (item[0], np.array(item[1], np.int))</span>
            <span class="c1">#                         for item in d[&#39;neighbors_by_indices&#39;]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">neighbors_by_indices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]),</span> <span class="n">structure_environments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">structure</span><span class="o">=</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]),</span>
                   <span class="n">bva_valences</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;bva_valences&#39;</span><span class="p">],</span>
                   <span class="n">coordination_environments</span><span class="o">=</span><span class="n">coordination_environments</span><span class="p">,</span>
                   <span class="n">neighbors</span><span class="o">=</span><span class="n">neighbors</span><span class="p">,</span>
                   <span class="n">neighbors_by_indices</span><span class="o">=</span><span class="n">neighbors_by_indices</span><span class="p">)</span></div></div>


<span class="c1"># class LightStructureEnvironmentsOld(MSONable):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Class used to store the chemical environments of a given structure obtained from a given ChemenvStrategy. Currently,</span>
<span class="c1">#     only strategies leading to the determination of a unique environment for each site is allowed</span>
<span class="c1">#     This class does not store all the information contained in the StructureEnvironments object, only the coordination</span>
<span class="c1">#     environment found</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, strategy_used, structure_environments=None, structure=None, bva_valences=None,</span>
<span class="c1">#                  coordination_environments=None, neighbors=None):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Constructor for the LightStructureEnvironments object.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if not strategy_used.uniquely_determines_coordination_environments:</span>
<span class="c1">#             raise NotImplementedError(&#39;LightStructureEnvironments not yet implemented with complex strategies leading &#39;</span>
<span class="c1">#                                       &#39;to multiple environments of a same site ...&#39;)</span>
<span class="c1">#         self.strategy_used = strategy_used</span>
<span class="c1">#         self._uniquely_determined_coordination_environments = strategy_used.uniquely_determines_coordination_environments</span>
<span class="c1">#         self._neighbors = []</span>
<span class="c1">#         self._coordination_environments = []</span>
<span class="c1">#         if structure_environments is not None:</span>
<span class="c1">#             self.strategy_used.set_structure_environments(structure_environments)</span>
<span class="c1">#             self.structure = structure_environments.structure</span>
<span class="c1">#             self.bva_valences = structure_environments.bva_valences</span>
<span class="c1">#             for site in self.strategy_used.structure_environments.structure:</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     this_site_neighbors = self.strategy_used.get_site_neighbors(site)</span>
<span class="c1">#                     self._neighbors.append(this_site_neighbors)</span>
<span class="c1">#                     try:</span>
<span class="c1">#                         (ce, ce_dict) = self.strategy_used.get_site_coordination_environment(site)</span>
<span class="c1">#                         self._coordination_environments.append(ce)</span>
<span class="c1">#                     except TypeError:</span>
<span class="c1">#                         cn = self.strategy_used.get_site_coordination_environment(site)</span>
<span class="c1">#                         self._coordination_environments.append(cn)</span>
<span class="c1">#                 except NeighborsNotComputedChemenvError:</span>
<span class="c1">#                     self._neighbors.append(None)</span>
<span class="c1">#                     self._coordination_environments.append(None)</span>
<span class="c1">#         else:</span>
<span class="c1">#             if structure is None or coordination_environments is None or neighbors is None or bva_valences is None:</span>
<span class="c1">#                 raise InitializationChemenvError(self.__class__.__name__)</span>
<span class="c1">#             self.structure = structure</span>
<span class="c1">#             self._coordination_environments = coordination_environments</span>
<span class="c1">#             self._neighbors = neighbors</span>
<span class="c1">#             self.bva_valences = bva_valences</span>
<span class="c1">#         self._neighbors_by_indices = []</span>
<span class="c1">#         for this_site_neighbors in self._neighbors:</span>
<span class="c1">#             if this_site_neighbors is None:</span>
<span class="c1">#                 self._neighbors_by_indices.append(None)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 this_site_neighbors_indices = []</span>
<span class="c1">#                 for neighbor in this_site_neighbors:</span>
<span class="c1">#                     ineighbor = None</span>
<span class="c1">#                     for isite, site in enumerate(self.structure):</span>
<span class="c1">#                         found = False</span>
<span class="c1">#                         for tolerance in [1e-8, 1e-6, 1e-4, 1e-3]:</span>
<span class="c1">#                             if site.is_periodic_image(neighbor, check_lattice=False, tolerance=tolerance):</span>
<span class="c1">#                                 ineighbor = isite</span>
<span class="c1">#                                 diff = neighbor.frac_coords - site.frac_coords</span>
<span class="c1">#                                 image_cell = np.array(np.round(diff), np.int)</span>
<span class="c1">#                                 #if np.allclose(image_cell, np.zeros(3, np.int)):</span>
<span class="c1">#                                 #    image_cell = 0</span>
<span class="c1">#                                 found = True</span>
<span class="c1">#                                 break</span>
<span class="c1">#                         if found:</span>
<span class="c1">#                             break</span>
<span class="c1">#                     if not found:</span>
<span class="c1">#                         raise ChemenvError(&#39;LightStructureEnvironments&#39;, &#39;__init__&#39;, &#39;Site indices not found&#39;)</span>
<span class="c1">#                     this_site_neighbors_indices.append((ineighbor, image_cell))</span>
<span class="c1">#                 self._neighbors_by_indices.append(this_site_neighbors_indices)</span>
<span class="c1">#         self.setup_statistic_lists()</span>
<span class="c1">#</span>
<span class="c1">#     def contains_only_one_anion_atom(self, anion_atom):</span>
<span class="c1">#         return len(self.anion_atom_list) == 1 and self.anion_atom_list[0] == anion_atom</span>
<span class="c1">#</span>
<span class="c1">#     def contains_only_one_anion(self, anion):</span>
<span class="c1">#         return len(self.anion_list) == 1 and self.anion_list[0] == anion</span>
<span class="c1">#</span>
<span class="c1">#     def site_contains_environment(self, isite, mp_symbol):</span>
<span class="c1">#         if self.uniquely_determined_coordination_environments:</span>
<span class="c1">#             return self.coordination_environments[isite] == mp_symbol</span>
<span class="c1">#         else:</span>
<span class="c1">#             return mp_symbol in self.coordination_environments[isite]</span>
<span class="c1">#</span>
<span class="c1">#     def structure_contains_atom_environment(self, atom_symbol, mp_symbol):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Checks whether the structure contains a given atom in a given environment</span>
<span class="c1">#         :param atom_symbol: Symbol of the atom</span>
<span class="c1">#         :param mp_symbol: Symbol of the coordination environment</span>
<span class="c1">#         :return: True if the coordination environment is found, False otherwise</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if self.uniquely_determined_coordination_environments:</span>
<span class="c1">#             for isite, site in enumerate(self.structure):</span>
<span class="c1">#                 if Element(atom_symbol) in site.species_and_occu.element_composition:</span>
<span class="c1">#                     if self.coordination_environments[isite] == mp_symbol:</span>
<span class="c1">#                         return True</span>
<span class="c1">#             return False</span>
<span class="c1">#         else:</span>
<span class="c1">#             for isite, site in enumerate(self.structure):</span>
<span class="c1">#                 if Element(atom_symbol) in site.species_and_occu.element_composition:</span>
<span class="c1">#                     if mp_symbol in self.coordination_environments[isite]:</span>
<span class="c1">#                         return True</span>
<span class="c1">#             return False</span>
<span class="c1">#</span>
<span class="c1">#     def setup_statistic_lists(self):</span>
<span class="c1">#         self.anion_list = []</span>
<span class="c1">#         self.anion_atom_list = []</span>
<span class="c1">#         self.cation_list = []</span>
<span class="c1">#         self.cation_atom_list = []</span>
<span class="c1">#         self.coordination_environments_present = {}</span>
<span class="c1">#         self.site_count_with_computed_ce = 0.0</span>
<span class="c1">#         self.atom_coordination_environments_present = {}</span>
<span class="c1">#         self.atom_count_with_computed_ce = {}</span>
<span class="c1">#         self.structure_ion_coordination_environments_present = {}</span>
<span class="c1">#         self.structure_ion_count_with_computed_ce = {}</span>
<span class="c1">#         self.bva_ion_coordination_environments_present = {}</span>
<span class="c1">#         self.bva_ion_count_with_computed_ce = {}</span>
<span class="c1">#         self.coordination_environments_bva_ion_present = {}</span>
<span class="c1">#         self.fraction_bva_ion_coordination_environments_present = {}</span>
<span class="c1">#         self.fraction_coordination_environments_bva_ion_present = {}</span>
<span class="c1">#         for isite, site in enumerate(self.structure):</span>
<span class="c1">#             #Building anion list</span>
<span class="c1">#             if self.bva_valences != &#39;undefined&#39;:</span>
<span class="c1">#                 for sp, occ in site.species_and_occu.items():</span>
<span class="c1">#                     if self.bva_valences[isite] &lt; 0:</span>
<span class="c1">#                         stranion = str(Specie(sp.symbol, self.bva_valences[isite]))</span>
<span class="c1">#                         if stranion not in self.anion_list:</span>
<span class="c1">#                             self.anion_list.append(stranion)</span>
<span class="c1">#                         if sp.symbol not in self.anion_atom_list:</span>
<span class="c1">#                             self.anion_atom_list.append(sp.symbol)</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         strcation = str(Specie(sp.symbol, self.bva_valences[isite]))</span>
<span class="c1">#                         if strcation not in self.cation_list:</span>
<span class="c1">#                             self.cation_list.append(strcation)</span>
<span class="c1">#                         if sp.symbol not in self.cation_atom_list:</span>
<span class="c1">#                             self.cation_atom_list.append(sp.symbol)</span>
<span class="c1">#             if self.coordination_environments[isite] is not None:</span>
<span class="c1">#                 ce = &#39;{}&#39;.format(self.coordination_environments[isite])</span>
<span class="c1">#                 self.site_count_with_computed_ce += 1.0</span>
<span class="c1">#                 if not ce in self.coordination_environments_present:</span>
<span class="c1">#                     self.coordination_environments_present[ce] = 1</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     self.coordination_environments_present[ce] += 1</span>
<span class="c1">#                 for specie in site.species_and_occu:</span>
<span class="c1">#                     #Counting atoms in specific environments</span>
<span class="c1">#                     if specie.symbol not in self.atom_coordination_environments_present:</span>
<span class="c1">#                         self.atom_coordination_environments_present[specie.symbol] = {}</span>
<span class="c1">#                     atom_ce = &#39;{}&#39;.format(self.coordination_environments[isite])</span>
<span class="c1">#                     if not atom_ce in self.atom_coordination_environments_present:</span>
<span class="c1">#                         self.atom_coordination_environments_present[specie.symbol][atom_ce] = site.species_and_occu[specie]</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         self.atom_coordination_environments_present[specie.symbol][atom_ce] += site.species_and_occu[specie]</span>
<span class="c1">#                     #Counting atoms for which environments are determined</span>
<span class="c1">#                     if specie.symbol not in self.atom_count_with_computed_ce:</span>
<span class="c1">#                         self.atom_count_with_computed_ce[specie.symbol] = site.species_and_occu[specie]</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         self.atom_count_with_computed_ce[specie.symbol] += site.species_and_occu[specie]</span>
<span class="c1">#                     #Counting ions in specific environments</span>
<span class="c1">#                     if specie.symbol not in self.structure_ion_coordination_environments_present:</span>
<span class="c1">#                         self.structure_ion_coordination_environments_present[specie.symbol] = {}</span>
<span class="c1">#                     try:</span>
<span class="c1">#                         str_sp_oxi_state = str(specie.oxi_state)</span>
<span class="c1">#                     except AttributeError:</span>
<span class="c1">#                         str_sp_oxi_state = &#39;element&#39;</span>
<span class="c1">#                     str_sp_oxi_state = str_sp_oxi_state.replace(&#39;.&#39;, &#39;,&#39;)</span>
<span class="c1">#                     if str_sp_oxi_state not in self.structure_ion_coordination_environments_present[specie.symbol]:</span>
<span class="c1">#                         self.structure_ion_coordination_environments_present[specie.symbol][str_sp_oxi_state] = {}</span>
<span class="c1">#                     ion_ce = &#39;{}&#39;.format(self.coordination_environments[isite])</span>
<span class="c1">#                     if ion_ce not in self.structure_ion_coordination_environments_present[specie.symbol][str_sp_oxi_state]:</span>
<span class="c1">#                         self.structure_ion_coordination_environments_present[specie.symbol][str_sp_oxi_state][ion_ce] = site.species_and_occu[specie]</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         self.structure_ion_coordination_environments_present[specie.symbol][str_sp_oxi_state][ion_ce] += site.species_and_occu[specie]</span>
<span class="c1">#                     #Counting ions for which environments are determined</span>
<span class="c1">#                     if specie.symbol not in self.structure_ion_count_with_computed_ce:</span>
<span class="c1">#                         self.structure_ion_count_with_computed_ce[specie.symbol] = {}</span>
<span class="c1">#                     if str_sp_oxi_state not in self.structure_ion_count_with_computed_ce[specie.symbol]:</span>
<span class="c1">#                         self.structure_ion_count_with_computed_ce[specie.symbol][str_sp_oxi_state] = site.species_and_occu[specie]</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         self.structure_ion_count_with_computed_ce[specie.symbol][str_sp_oxi_state] += site.species_and_occu[specie]</span>
<span class="c1">#                         #Counting ions in specific environments</span>
<span class="c1">#                     if specie.symbol not in self.bva_ion_coordination_environments_present:</span>
<span class="c1">#                         self.bva_ion_coordination_environments_present[specie.symbol] = {}</span>
<span class="c1">#                     if self.bva_valences != &#39;undefined&#39;:</span>
<span class="c1">#                         str_val = str(self.bva_valences[isite])</span>
<span class="c1">#                         if str_val not in self.bva_ion_coordination_environments_present[specie.symbol]:</span>
<span class="c1">#                             self.bva_ion_coordination_environments_present[specie.symbol][str_val] = {}</span>
<span class="c1">#                         ion_ce = &#39;{}&#39;.format(self.coordination_environments[isite])</span>
<span class="c1">#                         if ion_ce not in self.bva_ion_coordination_environments_present[specie.symbol][str_val]:</span>
<span class="c1">#                             self.bva_ion_coordination_environments_present[specie.symbol][str_val][ion_ce] = site.species_and_occu[specie]</span>
<span class="c1">#                         else:</span>
<span class="c1">#                             self.bva_ion_coordination_environments_present[specie.symbol][str_val][ion_ce] += site.species_and_occu[specie]</span>
<span class="c1">#                         if specie.symbol not in self.bva_ion_count_with_computed_ce:</span>
<span class="c1">#                             self.bva_ion_count_with_computed_ce[specie.symbol] = {}</span>
<span class="c1">#                         if str_val not in self.bva_ion_count_with_computed_ce[specie.symbol]:</span>
<span class="c1">#                             self.bva_ion_count_with_computed_ce[specie.symbol][str_val] = site.species_and_occu[specie]</span>
<span class="c1">#                         else:</span>
<span class="c1">#                             self.bva_ion_count_with_computed_ce[specie.symbol][str_val] += site.species_and_occu[specie]</span>
<span class="c1">#         for ce in self.coordination_environments_present:</span>
<span class="c1">#             self.coordination_environments_bva_ion_present[ce] = {}</span>
<span class="c1">#         for sp, spdict in self.bva_ion_coordination_environments_present.items():</span>
<span class="c1">#             self.fraction_bva_ion_coordination_environments_present[sp] = {}</span>
<span class="c1">#             for val, valdict in spdict.items():</span>
<span class="c1">#                 strbvasp = str(Specie(sp, int(val)))</span>
<span class="c1">#                 self.fraction_bva_ion_coordination_environments_present[sp][val] = {}</span>
<span class="c1">#                 for ion_ce, n_ion_ce in valdict.items():</span>
<span class="c1">#                     self.fraction_bva_ion_coordination_environments_present[sp][val][ion_ce] = float(n_ion_ce) / self.bva_ion_count_with_computed_ce[sp][val]</span>
<span class="c1">#                     if strbvasp in self.coordination_environments_bva_ion_present[ion_ce]:</span>
<span class="c1">#                         self.coordination_environments_bva_ion_present[ion_ce][strbvasp] += n_ion_ce</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         self.coordination_environments_bva_ion_present[ion_ce][strbvasp] = n_ion_ce</span>
<span class="c1">#         for ce, cedict in self.coordination_environments_bva_ion_present.items():</span>
<span class="c1">#             self.fraction_coordination_environments_bva_ion_present[ce] = {}</span>
<span class="c1">#             for cation, ncations in cedict.items():</span>
<span class="c1">#                 self.fraction_coordination_environments_bva_ion_present[ce][cation] = float(ncations) / self.coordination_environments_present[ce]</span>
<span class="c1">#</span>
<span class="c1">#     @property</span>
<span class="c1">#     def coordination_environments(self):</span>
<span class="c1">#         return self._coordination_environments</span>
<span class="c1">#</span>
<span class="c1">#     @property</span>
<span class="c1">#     def uniquely_determined_coordination_environments(self):</span>
<span class="c1">#         return self._uniquely_determined_coordination_environments</span>
<span class="c1">#</span>
<span class="c1">#     @property</span>
<span class="c1">#     def neighbors(self):</span>
<span class="c1">#         return self._neighbors</span>
<span class="c1">#</span>
<span class="c1">#     @property</span>
<span class="c1">#     def neighbors_by_indices(self):</span>
<span class="c1">#         return self._neighbors_by_indices</span>
<span class="c1">#</span>
<span class="c1">#     def __eq__(self, other):</span>
<span class="c1">#         return (self.strategy_used == other.strategy_used and self.structure == other.structure and</span>
<span class="c1">#                 self.bva_valences == other.bva_valences and</span>
<span class="c1">#                 self._coordination_environments == other._coordination_environments and</span>
<span class="c1">#                 self._neighbors == other._neighbors)</span>
<span class="c1">#</span>
<span class="c1">#     def as_dict(self):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Bson-serializable dict representation of the LightStructureEnvironments object.</span>
<span class="c1">#         :return: Bson-serializable dict representation of the LightStructureEnvironments object.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         #strategy_used, structure_environments=None, structure=None, coordination_environments=None,</span>
<span class="c1">#         #         neighbors=None</span>
<span class="c1">#         return {&quot;@module&quot;: self.__class__.__module__,</span>
<span class="c1">#                 &quot;@class&quot;: self.__class__.__name__,</span>
<span class="c1">#                 &quot;strategy_used&quot;: self.strategy_used.as_dict(),</span>
<span class="c1">#                 &quot;structure&quot;: self.structure.as_dict(),</span>
<span class="c1">#                 &quot;bva_valences&quot;: self.bva_valences,</span>
<span class="c1">#                 &quot;coordination_environments&quot;: self._coordination_environments,</span>
<span class="c1">#                 &quot;neighbors&quot;: [[ps.as_dict() for ps in neighbs] if neighbs is not None else None</span>
<span class="c1">#                               for neighbs in self._neighbors]}</span>
<span class="c1">#</span>
<span class="c1">#     @classmethod</span>
<span class="c1">#     def from_dict(cls, d):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Reconstructs the LightStructureEnvironments object from a dict representation of the</span>
<span class="c1">#         LightStructureEnvironments created using the as_dict method.</span>
<span class="c1">#         :param d: dict representation of the LightStructureEnvironments object</span>
<span class="c1">#         :return: LightStructureEnvironments object</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         dec = MontyDecoder()</span>
<span class="c1">#         return cls(dec.process_decoded(d[&#39;strategy_used&#39;]), structure_environments=None,</span>
<span class="c1">#                    structure=dec.process_decoded(d[&#39;structure&#39;]),</span>
<span class="c1">#                    bva_valences=d[&#39;bva_valences&#39;],</span>
<span class="c1">#                    coordination_environments=d[&#39;coordination_environments&#39;],</span>
<span class="c1">#                    neighbors=dec.process_decoded(d[&#39;neighbors&#39;]))</span>


<div class="viewcode-block" id="ChemicalEnvironments"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.ChemicalEnvironments">[docs]</a><span class="k">class</span> <span class="nc">ChemicalEnvironments</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class used to store all the information about the chemical environment of a given site for a given list of</span>
<span class="sd">    coordinated neighbours (internally called &quot;cn_map&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_geoms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the ChemicalEnvironments object containing all the information about the chemical</span>
<span class="sd">        environment of a given site</span>
<span class="sd">        :param coord_geoms: coordination geometries to be added to the chemical environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coord_geoms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Constructor for ChemicalEnvironments with the coord_geoms argument is not&#39;</span>
                                      <span class="s1">&#39;yet implemented&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mp_symbol</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mp_symbol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of coordination geometries in this ChemicalEnvironments object</span>
<span class="sd">        :return: Number of coordination geometries in this ChemicalEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">)</span>

<div class="viewcode-block" id="ChemicalEnvironments.minimum_geometry"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.ChemicalEnvironments.minimum_geometry">[docs]</a>    <span class="k">def</span> <span class="nf">minimum_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symmetry_measure_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_csm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the geometry with the minimum continuous symmetry measure of this ChemicalEnvironments</span>
<span class="sd">        :return: tuple (symbol, csm) with symbol being the geometry with the minimum continuous symmetry measure and</span>
<span class="sd">        csm being the continuous symmetry measure associted to it</span>
<span class="sd">        :raise: ValueError if no coordination geometry is found in this ChemicalEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">cglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cg</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">symmetry_measure_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">csms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="s1">&#39;csm_wcs_ctwcc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cglist</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">csms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="n">symmetry_measure_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cglist</span><span class="p">])</span>
        <span class="n">csmlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">cg</span><span class="p">]</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cglist</span><span class="p">]</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">csms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_csm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_csm</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">cglist</span><span class="p">[</span><span class="n">imin</span><span class="p">],</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">imin</span><span class="p">]</span></div>

<div class="viewcode-block" id="ChemicalEnvironments.minimum_geometries"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.ChemicalEnvironments.minimum_geometries">[docs]</a>    <span class="k">def</span> <span class="nf">minimum_geometries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">symmetry_measure_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_csm</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of geometries with increasing continuous symmetry measure in this ChemicalEnvironments object</span>
<span class="sd">        :param n: Number of geometries to be included in the list</span>
<span class="sd">        :return: list of geometries with increasing continuous symmetry measure in this ChemicalEnvironments object</span>
<span class="sd">        :raise: ValueError if no coordination geometry is found in this ChemicalEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">cg</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">symmetry_measure_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">csms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="s1">&#39;csm_wcs_ctwcc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cglist</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">csms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="n">symmetry_measure_type</span><span class="p">]</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cglist</span><span class="p">])</span>
        <span class="n">csmlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">cg</span><span class="p">]</span> <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">cglist</span><span class="p">]</span>
        <span class="n">isorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">csms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_csm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">cglist</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">isorted</span> <span class="k">if</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_csm</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">cglist</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">isorted</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="k">if</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_csm</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">cglist</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">isorted</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">cglist</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">csmlist</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">isorted</span><span class="p">[:</span><span class="n">n</span><span class="p">]]</span></div>

<div class="viewcode-block" id="ChemicalEnvironments.add_coord_geom"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.ChemicalEnvironments.add_coord_geom">[docs]</a>    <span class="k">def</span> <span class="nf">add_coord_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mp_symbol</span><span class="p">,</span> <span class="n">symmetry_measure</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">,</span> <span class="n">permutation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">local2perfect_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perfect2local_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detailed_voronoi_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">other_symmetry_measures</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a coordination geometry to the ChemicalEnvironments object</span>
<span class="sd">        :param mp_symbol: Symbol (internal) of the coordination geometry added</span>
<span class="sd">        :param symmetry_measure: Symmetry measure of the coordination geometry added</span>
<span class="sd">        :param algo: Algorithm used for the search of the coordination geometry added</span>
<span class="sd">        :param permutation: Permutation of the neighbors that leads to the csm stored</span>
<span class="sd">        :param override: If set to True, the coordination geometry will override the existent one if present</span>
<span class="sd">        :return: :raise: ChemenvError if the coordination geometry is already added and override is set to False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allcg</span><span class="o">.</span><span class="n">is_a_valid_coordination_geometry</span><span class="p">(</span><span class="n">mp_symbol</span><span class="o">=</span><span class="n">mp_symbol</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ChemenvError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span>
                               <span class="s1">&#39;add_coord_geom&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;Coordination geometry with mp_symbol &quot;</span><span class="si">{mp}</span><span class="s1">&quot; is not valid&#39;</span>
                               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp</span><span class="o">=</span><span class="n">mp_symbol</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">mp_symbol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChemenvError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span>
                               <span class="s2">&quot;add_coord_geom&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;This coordination geometry is already present and override is set to False&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;symmetry_measure&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">symmetry_measure</span><span class="p">),</span> <span class="s1">&#39;algo&#39;</span><span class="p">:</span> <span class="n">algo</span><span class="p">,</span>
                                           <span class="s1">&#39;permutation&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">permutation</span><span class="p">],</span>
                                           <span class="s1">&#39;local2perfect_map&#39;</span><span class="p">:</span> <span class="n">local2perfect_map</span><span class="p">,</span>
                                           <span class="s1">&#39;perfect2local_map&#39;</span><span class="p">:</span> <span class="n">perfect2local_map</span><span class="p">,</span>
                                           <span class="s1">&#39;detailed_voronoi_index&#39;</span><span class="p">:</span> <span class="n">detailed_voronoi_index</span><span class="p">,</span>
                                           <span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">:</span> <span class="n">other_symmetry_measures</span><span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the ChemicalEnvironments object</span>
<span class="sd">        :return: String representation of the ChemicalEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;Chemical environments object :</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; =&gt; No coordination in it &lt;=</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">mp_symbol</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">break</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">symbol_cn_mapping</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">]</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39; =&gt; Coordination </span><span class="si">{}</span><span class="s1"> &lt;=</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cn</span><span class="p">)</span>
        <span class="n">mp_symbols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">csms_wcs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="s1">&#39;csm_wcs_ctwcc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mp_symbol</span> <span class="ow">in</span> <span class="n">mp_symbols</span><span class="p">]</span>
        <span class="n">icsms_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">csms_wcs</span><span class="p">)</span>
        <span class="n">mp_symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mp_symbols</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">icsms_sorted</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mp_symbol</span> <span class="ow">in</span> <span class="n">mp_symbols</span><span class="p">:</span>
            <span class="n">csm_wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="s1">&#39;csm_wcs_ctwcc&#39;</span><span class="p">]</span>
            <span class="n">csm_wocs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">][</span><span class="s1">&#39;csm_wocs_ctwocc&#39;</span><span class="p">]</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;   - </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mp_symbol</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;      csm1 (with central site) : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csm_wcs</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;      csm2 (without central site) : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">csm_wocs</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;     algo : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;algo&#39;</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;     perm : </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;permutation&#39;</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;       local2perfect : </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;local2perfect_map&#39;</span><span class="p">]))</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s1">&#39;       perfect2local : </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">[</span><span class="n">mp_symbol</span><span class="p">][</span><span class="s1">&#39;perfect2local_map&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Equality method that checks if the ChemicalEnvironments object is equal to another ChemicalEnvironments</span>
<span class="sd">        object.</span>
<span class="sd">        :param other: ChemicalEnvironments object to compare with</span>
<span class="sd">        :return: True if both objects are equal, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">coord_geoms</span>

<div class="viewcode-block" id="ChemicalEnvironments.as_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.ChemicalEnvironments.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a dictionary representation of the ChemicalEnvironments object</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;@module&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span>
                <span class="s2">&quot;@class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                <span class="s2">&quot;coord_geoms&quot;</span><span class="p">:</span> <span class="n">jsanitize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_geoms</span><span class="p">)}</span></div>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="ChemicalEnvironments.from_dict"><a class="viewcode-back" href="../../../../../pymatgen.analysis.chemenv.coordination_environments.html#pymatgen.analysis.chemenv.coordination_environments.structure_environments.ChemicalEnvironments.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconstructs the ChemicalEnvironments object from a dict representation of the ChemicalEnvironments created</span>
<span class="sd">        using the as_dict method.</span>
<span class="sd">        :param d: dict representation of the ChemicalEnvironments object</span>
<span class="sd">        :return: ChemicalEnvironments object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ce</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cg</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;local2perfect_map&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">l2p_map</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">l2p_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;local2perfect_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;perfect2local_map&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">p2l_map</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p2l_map</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">):</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;perfect2local_map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;other_symmetry_measures&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">]</span> <span class="ow">and</span>
                        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">other_csms</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;other_symmetry_measures&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other_csms</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ce</span><span class="o">.</span><span class="n">add_coord_geom</span><span class="p">(</span><span class="n">cg</span><span class="p">,</span>
                              <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;symmetry_measure&#39;</span><span class="p">],</span>
                              <span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;algo&#39;</span><span class="p">],</span>
                              <span class="n">permutation</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;permutation&#39;</span><span class="p">],</span>
                              <span class="n">local2perfect_map</span><span class="o">=</span><span class="n">l2p_map</span><span class="p">,</span>
                              <span class="n">perfect2local_map</span><span class="o">=</span><span class="n">p2l_map</span><span class="p">,</span>
                              <span class="n">detailed_voronoi_index</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;coord_geoms&#39;</span><span class="p">][</span><span class="n">cg</span><span class="p">][</span><span class="s1">&#39;detailed_voronoi_index&#39;</span><span class="p">],</span>
                              <span class="n">other_symmetry_measures</span><span class="o">=</span><span class="n">other_csms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ce</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../../../index.html">pymatgen 4.3.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2011, Pymatgen Development Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>